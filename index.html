<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å°è‚¡è¶¨å‹¢AIå°ˆæ¥­åˆ†æåŠ©æ‰‹ - Joseph PAI 2025 (Final v21)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: white; font-family: 'Microsoft JhengHei',sans-serif; }
        .container { max-width: 1350px; }
        .card { background: rgba(255,255,255,0.12); backdrop-filter: blur(12px); border: none; box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
        .score-big { font-size: 6.5rem; font-weight: 900; text-shadow: 0 6px 15px rgba(0,0,0,0.6); }
        .badge-pos { background: #28a745; }
        .badge-neg { background: #dc3545; }
        .weight-input { width: 80px; text-align: center; font-weight: bold; background:#fff; color:#333; }
        .summary { background: rgba(0,0,0,0.4); padding: 30px; border-radius: 15px; margin: 30px 0; }
        footer { margin-top: 80px; padding: 30px; text-align: center; color: rgba(255,255,255,0.8); }
        .debug-log { max-height: 500px; overflow-y: auto; background: rgba(0,0,0,0.8); color: #0f0; font-family: monospace; padding: 15px; border-radius: 8px; }
        .token-status { font-weight: bold; }
        .data-source { font-size: 0.8rem; color: #ffc107; margin-top: 10px; }
        .date-range-input { width: 120px; }
        .manual-input { width: 100%; text-align: center; font-size: 1rem; }
        .explanation { background: white; color: black; padding: 15px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem; }
        .explanation h6 { color: #8B0000; margin-bottom: 5px; font-weight: bold; }
        .manual-input-cell { padding: 5px !important; width: 100px; }
        .manual-label { font-size: 1rem; color: #ffc107; font-weight: bold; }
        .table-header-red { background-color: #8B0000; color: white; }
        .period-select { width: 110px; font-size: 0.9rem; cursor: pointer; }
        .financial-period { background-color: rgba(255, 255, 255, 0.1); padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        .basis-box { background: rgba(0,0,0,0.3); border-left: 4px solid #ffc107; padding: 15px; margin-top: 20px; border-radius: 4px; }
        td, th { vertical-align: middle; }
        .stock-search { max-width: 300px; }
        
        /* æ–°å¢æ ·å¼ */
        .ai-analysis-section { margin-bottom: 20px; }
        .ai-analysis-toggle { cursor: pointer; }
        .ai-analysis-content { margin-top: 15px; }
        .chart-container { margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.9); border-radius: 10px; }
        .data-section { margin: 15px 0; padding: 10px; }
        
        /* å…¬å¸ç±»å‹é€‰æ‹©æ ·å¼ */
        .company-type-badge { font-size: 0.75rem; padding: 2px 6px; }
        .company-type-select { width: 120px; }
        .detected-type { margin-left: 8px; font-size: 0.85rem; }
        .type-listed { color: #28a745; }
        .type-emerging { color: #ffc107; }
        .type-unknown { color: #6c757d; }
        
        /* æ–°å¢æ ·å¼ */
        .validation-error { border-color: #dc3545 !important; box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25); }
        .validation-success { border-color: #28a745 !important; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .retry-btn { margin-left: 10px; }
        
        /* æ–°å¢ï¼šè‚¡ç¥¨é€‰æ‹©ç›¸å…³æ ·å¼ */
        .stock-select-tab { background: rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .stock-select-tab .nav-link { color: rgba(255,255,255,0.8); }
        .stock-select-tab .nav-link.active { background: rgba(255,255,255,0.2); color: white; font-weight: bold; }
        .hot-stock-btn { margin: 2px; font-size: 0.85rem; }
        .stock-search-section { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; }
        
        /* æ–°å¢ï¼šæœå°‹æ­·å²æ¨£å¼ */
        .search-history-item { cursor: pointer; padding: 5px 10px; border-radius: 4px; margin: 2px 0; }
        .search-history-item:hover { background: rgba(255,255,255,0.1); }
        .quick-search-dropdown { max-height: 200px; overflow-y: auto; }
        
        /* æ–°å¢ï¼šåŠ è¼‰ä¸­æ¨£å¼ */
        .loading-spinner { display: inline-block; width: 1rem; height: 1rem; vertical-align: text-bottom; border: 0.15em solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spinner-border .75s linear infinite; }
        @keyframes spinner-border { to { transform: rotate(360deg); } }
        
        /* æ–°å¢ï¼šæœç´¢ç¢ºèªæŒ‰éˆ•æ¨£å¼ */
        .search-confirm-btn { margin-top: 5px; }
        
        /* æ–°å¢ï¼šæ¨¡ç³ŠæŸ¥è©¢ä¸‹æ‹‰é¸å–®æ¨£å¼ */
        .search-suggestions {
            position: absolute;
            z-index: 1000;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }
        .search-suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            color: #333;
            border-bottom: 1px solid #f0f0f0;
        }
        .search-suggestion-item:hover {
            background-color: #f5f5f5;
        }
        .search-suggestion-item .stock-code {
            font-weight: bold;
            color: #007bff;
        }
        .search-suggestion-item .stock-name {
            margin-left: 8px;
            color: #666;
        }
        .search-suggestion-item .stock-type {
            float: right;
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .search-suggestion-item .type-listed {
            background-color: #28a745;
            color: white;
        }
        .search-suggestion-item .type-otc {
            background-color: #007bff;
            color: white;
        }
        .search-suggestion-item .type-emerging {
            background-color: #ffc107;
            color: #212529;
        }
    </style>
</head>
<body>
<div class="container py-5">

    <h1 class="text-center mb-2">å°è‚¡è¶¨å‹¢AIå°ˆæ¥­åˆ†æåŠ©æ‰‹</h1>
    <p class="text-center text-white-50 mb-5">Joseph PAI 2025 11/26 å°ˆæ¥­è©•åˆ†è©³è§£ç‰ˆ â€¢ Netlify Functions + TWSE/TPEx API</p>

    <div class="row justify-content-center mb-4">
        <div class="col-md-8">
            <!-- ä¿®æ”¹å¾Œçš„ Token è¼¸å…¥å€åŸŸ -->
            <div class="mb-3">
                <label class="form-label text-white-50 mb-2">FinMind Tokenï¼ˆé¸å¡«ï¼‰</label>
                <div class="input-group">
                    <input type="text" id="tokenInput" class="form-control bg-white text-dark" placeholder="è²¼ä¸Š Token æˆ–ç•™ç©ºä½¿ç”¨å…¬é–‹è³‡æ–™">
                    <button class="btn btn-warning fw-bold" id="saveToken">å„²å­˜</button>
                </div>
            </div>
            <small class="text-white-50">å…è²»è¨»å†Š â†’ <a href="https://finmindtrade.com/analysis/#/account/register" target="_blank" class="text-warning">FinMindï¼ˆ30ç§’ï¼‰</a> ï½œ æˆ–ç›´æ¥ä½¿ç”¨è­‰äº¤æ‰€+è§€æ¸¬ç«™å…¬é–‹è³‡æ–™</small>
            <div id="tokenStatus" class="token-status mt-2"></div>
        </div>
    </div>

    <!-- å…¬å¸é¡å‹èˆ‡è‚¡ç¥¨é¸æ“‡å€åŸŸ -->
    <div class="row justify-content-center mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <strong>ğŸ“Š è‚¡ç¥¨é¸æ“‡</strong>
                </div>
                <div class="card-body">
                    <!-- å…¬å¸é¡å‹é¸æ“‡ -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-12">
                            <label class="form-label text-white-50"><strong>å…¬å¸é¡å‹ï¼ˆå¿…é¸ï¼‰</strong></label>
                            <div class="btn-group w-100" role="group" id="companyTypeGroup">
                                <input type="radio" class="btn-check" name="companyType" id="companyTypeAuto" value="auto" autocomplete="off" checked>
                                <label class="btn btn-outline-info" for="companyTypeAuto">è‡ªå‹•æª¢æ¸¬</label>
                                
                                <input type="radio" class="btn-check" name="companyType" id="companyTypeListed" value="listed" autocomplete="off">
                                <label class="btn btn-outline-success" for="companyTypeListed">ä¸Šå¸‚å…¬å¸</label>
                                
                                <input type="radio" class="btn-check" name="companyType" id="companyTypeOTC" value="otc" autocomplete="off">
                                <label class="btn btn-outline-primary" for="companyTypeOTC">ä¸Šæ«ƒå…¬å¸</label>
                                
                                <input type="radio" class="btn-check" name="companyType" id="companyTypeEmerging" value="emerging" autocomplete="off">
                                <label class="btn btn-outline-warning" for="companyTypeEmerging">èˆˆæ«ƒå…¬å¸</label>
                            </div>
                            <div id="detectedTypeDisplay" class="detected-type mt-2"></div>
                        </div>
                    </div>

                    <!-- ä¿®æ”¹å¾Œçš„ç‰ˆé¢é †åº -->
                    <!-- 1ã€è¼¸å…¥ä»£ç¢¼æˆ–åç¨±æœå°‹ -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-8">
                            <label class="form-label text-white-50"><strong>1. è¼¸å…¥ä»£ç¢¼æˆ–åç¨±æœå°‹</strong></label>
                            <div class="input-group position-relative">
                                <input type="text" id="searchStockInput" class="form-control" placeholder="è¼¸å…¥ä»£ç¢¼æˆ–åç¨±æœå°‹...">
                                <button class="btn btn-info text-white fw-bold" id="confirmSearchBtn">ç¢ºèª</button>
                                <!-- æ¨¡ç³ŠæŸ¥è©¢å»ºè­°ä¸‹æ‹‰é¸å–® -->
                                <div id="searchSuggestions" class="search-suggestions"></div>
                            </div>
                            <small class="text-white-50 d-block mt-1">è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–å…¬å¸åç¨±ï¼Œé»æ“Š"ç¢ºèª"é€²è¡Œå³æ™‚æœå°‹</small>
                        </div>
                    </div>

                    <!-- 2ã€é¸æ“‡è‚¡ç¥¨ -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-8">
                            <label class="form-label text-white-50"><strong>2. é¸æ“‡è‚¡ç¥¨</strong></label>
                            <select id="stockSelect" class="form-select" required>
                                <option value="">è«‹é¸æ“‡æˆ–æœå°‹è‚¡ç¥¨</option>
                            </select>
                            <div id="stockSelectLoading" class="mt-2" style="display: none;">
                                <small class="text-warning"><span class="loading-spinner"></span> è¼‰å…¥è‚¡ç¥¨æ¸…å–®ä¸­...</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-white-50"><strong>3. ç¢ºèª</strong></label>
                            <button class="btn btn-success text-white fw-bold w-100" id="confirmSelectionBtn">ç¢ºèªé¸æ“‡</button>
                        </div>
                    </div>

                    <!-- 4ã€é¸æ“‡é¡è‚¡ï¼ˆåƒ…ä¸Šå¸‚å…¬å¸å¯ç”¨ï¼‰ -->
                    <div class="row g-3 mb-4" id="categorySection">
                        <div class="col-md-8">
                            <label class="form-label text-white-50"><strong>4. é¸æ“‡é¡è‚¡ï¼ˆåƒ…ä¸Šå¸‚å…¬å¸å¯ç”¨ï¼‰</strong></label>
                            <select id="stockCategory" class="form-select">
                                <option value="all">å…¨éƒ¨é¡è‚¡</option>
                            </select>
                            <small class="text-white-50">ç•¶é¸æ“‡ã€Œä¸Šæ«ƒ/èˆˆæ«ƒå…¬å¸ã€æ™‚åœç”¨</small>
                        </div>
                    </div>

                    <!-- 5ã€é¸æ“‡è‚¡ç¥¨ï¼ˆä¸Šå¸‚å…¬å¸ï¼‰ -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-8">
                            <label class="form-label text-white-50"><strong>5. é¸æ“‡è‚¡ç¥¨ï¼ˆä¸Šå¸‚å…¬å¸ï¼‰</strong></label>
                            <select id="listedStockSelect" class="form-select">
                                <option value="">è«‹å…ˆé¸æ“‡é¡è‚¡</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-white-50"><strong>6. ç¢ºèª</strong></label>
                            <button class="btn btn-success text-white fw-bold w-100" id="confirmListedSelectionBtn">ç¢ºèªé¸æ“‡</button>
                        </div>
                    </div>

                    <!-- 7ã€å¿«é€Ÿæœå°‹ -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-8">
                            <label class="form-label text-white-50"><strong>7. å¿«é€Ÿæœå°‹</strong></label>
                            <select id="quickSearchSelect" class="form-select">
                                <option value="">é¸æ“‡ç†±é–€è‚¡ç¥¨æˆ–æœå°‹è¨˜éŒ„...</option>
                                <!-- æœå°‹æ­·å²å’Œç†±é–€è‚¡ç¥¨å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-white-50"><strong>8. é¸æ“‡</strong></label>
                            <button class="btn btn-info text-white fw-bold w-100" id="applyQuickSearch">é¸æ“‡</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- åˆ†ææ™‚é–“ç¯„åœ -->
    <div class="row justify-content-center mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <form id="analyzeForm">
                        <div class="row g-2 align-items-center">
                            <div class="col-md-3">
                                <label class="form-label text-white-50"><strong>åˆ†ææ™‚é–“ç¯„åœï¼š</strong></label>
                            </div>
                            <div class="col-md-2">
                                <select id="dateRange" class="form-select">
                                    <option value="30">æœ€è¿‘30å¤©</option>
                                    <option value="60" selected>æœ€è¿‘60å¤©</option>
                                    <option value="90">æœ€è¿‘90å¤©</option>
                                    <option value="180">æœ€è¿‘åŠå¹´</option>
                                    <option value="365">æœ€è¿‘ä¸€å¹´</option>
                                </select>
                            </div>
                            <div class="col-md-1 text-center">
                                <span class="text-white-50">æˆ–è‡ªè¨‚ï¼š</span>
                            </div>
                            <div class="col-md-2">
                                <input type="date" id="startDate" class="form-control" placeholder="é–‹å§‹æ—¥æœŸ">
                            </div>
                            <div class="col-md-1 text-center">
                                <span class="text-white-50">åˆ°</span>
                            </div>
                            <div class="col-md-2">
                                <input type="date" id="endDate" class="form-control" placeholder="çµæŸæ—¥æœŸ">
                            </div>
                            <div class="col-md-1">
                                <button class="btn btn-warning text-dark fw-bold w-100" type="submit">ç«‹å³åˆ†æ</button>
                            </div>
                        </div>
                    </form>
                    
                    <!-- æ•¸æ“šä¾†æºé¡¯ç¤º -->
                    <div id="dataSourceInfo" class="mt-3">
                        <small class="text-white-50">æ•¸æ“šä¾†æº: <span id="currentDataSource">æº–å‚™ä¸­...</span></small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI åˆ†æåŠŸèƒ½å€åŸŸ - é»˜èªéš±è— -->
    <div class="row justify-content-center mb-4 ai-analysis-section">
        <div class="col-md-12">
            <div class="card text-dark">
                <div class="card-header bg-info text-white ai-analysis-toggle" data-bs-toggle="collapse" data-bs-target="#aiAnalysisContent">
                    <strong>ğŸ” AI é›™é‡åˆ†æåŠ©æ‰‹</strong>
                    <small class="float-end">é»æ“Šå±•é–‹/æ”¶åˆ | åŒæ™‚åˆ†ææ¶ˆæ¯é¢èˆ‡é¢¨éšªé¢</small>
                </div>
                <div class="card-body collapse" id="aiAnalysisContent">
                    <div class="row g-3 align-items-center">
                        <div class="col-md-4">
                            <label class="form-label">AIå¹³å°é¸æ“‡</label>
                            <select id="aiPlatform" class="form-select">
                                <option value="deepseek">DeepSeek (æ¨è–¦)</option>
                                <option value="gpt">ChatGPT (OpenAI)</option>
                                <option value="gemini">Gemini (Google)</option>
                                <option value="claude">Claude (Anthropic)</option>
                                <option value="grok">Grok (xAI)</option>
                            </select>
                            <small class="text-muted">
                                <a href="#" id="getApiLink" class="text-primary">ğŸ“Œ ç²å–API Key</a>
                            </small>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">API Key</label>
                            <div class="input-group">
                                <input type="password" id="aiApiKey" class="form-control" placeholder="è¼¸å…¥é¸æ“‡å¹³å°çš„ API Key">
                                <button class="btn btn-outline-primary" type="button" id="verifyAiKey">é©—è­‰</button>
                            </div>
                            <small class="text-muted" id="apiKeyHint">è«‹è¼¸å…¥æœ‰æ•ˆçš„API Key</small>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">åˆ†ææ¨¡å¼</label>
                            <div class="d-flex flex-column">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="parallelAnalysis" checked>
                                    <label class="form-check-label" for="parallelAnalysis">
                                        ğŸš€ ä¸¦è¡Œé›™é‡åˆ†æ
                                    </label>
                                </div>
                                <small class="text-muted">åŒæ™‚é€²è¡Œæ¶ˆæ¯é¢èˆ‡é¢¨éšªé¢åˆ†æ</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="d-flex gap-2 flex-wrap">
                                <button class="btn btn-primary" id="aiAnalyzeBtn" disabled>
                                    <span class="spinner-border spinner-border-sm me-2" id="aiSpinner" style="display: none;"></span>
                                    ğŸ¤– é–‹å§‹é›™é‡åˆ†æ
                                </button>
                                <button class="btn btn-outline-secondary" id="clearAiAnalysis">
                                    ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰åˆ†æ
                                </button>
                                <button class="btn btn-outline-info" id="testConnectionBtn">
                                    ğŸ”— æ¸¬è©¦é€£ç·š
                                </button>
                                <button class="btn btn-outline-success" id="singleNewsAnalysis" disabled>
                                    ğŸ“° åƒ…æ¶ˆæ¯é¢åˆ†æ
                                </button>
                                <button class="btn btn-outline-warning" id="singleRiskAnalysis" disabled>
                                    âš ï¸ åƒ…é¢¨éšªé¢åˆ†æ
                                </button>
                                <div id="aiKeyStatus" class="ms-2 align-self-center"></div>
                            </div>
                        </div>
                    </div>

                    <!-- ä¸¦è¡Œåˆ†æé€²åº¦æŒ‡ç¤ºå™¨ -->
                    <div id="parallelProgress" class="mt-3" style="display: none;">
                        <div class="progress" style="height: 25px;">
                            <div id="newsProgress" class="progress-bar bg-danger" role="progressbar" style="width: 0%;">
                                æ¶ˆæ¯é¢åˆ†æä¸­...
                            </div>
                            <div id="riskProgress" class="progress-bar bg-warning" role="progressbar" style="width: 0%;">
                                é¢¨éšªé¢åˆ†æä¸­...
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <small id="newsStatus">ğŸ”„ ç­‰å¾…é–‹å§‹</small>
                            <small id="riskStatus">ğŸ”„ ç­‰å¾…é–‹å§‹</small>
                        </div>
                    </div>

                    <!-- AI é›™é‡åˆ†æçµæœé¡¯ç¤º -->
                    <div id="aiAnalysisResult" class="mt-4" style="display: none;">
                        <div class="row">
                            <!-- æ¶ˆæ¯é¢åˆ†æçµæœå€å¡Š -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-header bg-danger text-white">
                                        <strong>ğŸ“° æ¶ˆæ¯é¢åˆ†æçµæœ</strong>
                                        <div class="float-end">
                                            <span id="newsScoreBadge" class="badge bg-light text-dark">--/10</span>
                                            <button class="btn btn-sm btn-light ms-2" onclick="copyToClipboard('newsAnalysisContent')">ğŸ“‹</button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="border rounded p-3 bg-light" style="max-height: 400px; overflow-y: auto;">
                                            <pre id="newsAnalysisContent" style="white-space: pre-wrap; font-family: inherit; margin: 0;">è«‹å…ˆé€²è¡Œåˆ†æ...</pre>
                                        </div>
                                        <div class="mt-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <strong>è©•åˆ†: </strong>
                                                <span id="newsScoreDisplay" class="fs-4 fw-bold">--</span>
                                            </div>
                                            <div class="mt-2">
                                                <strong>å»ºè­°: </strong>
                                                <span id="newsComment" class="text-muted">--</span>
                                            </div>
                                            <button class="btn btn-sm btn-success w-100 mt-2" id="applyNewsScore">
                                                âœ… æ‡‰ç”¨æ¶ˆæ¯é¢è©•åˆ†
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- é¢¨éšªé¢åˆ†æçµæœå€å¡Š -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-header bg-warning text-dark">
                                        <strong>âš ï¸ é¢¨éšªé¢åˆ†æçµæœ</strong>
                                        <div class="float-end">
                                            <span id="riskScoreBadge" class="badge bg-light text-dark">--/10</span>
                                            <button class="btn btn-sm btn-light ms-2" onclick="copyToClipboard('riskAnalysisContent')">ğŸ“‹</button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="border rounded p-3 bg-light" style="max-height: 400px; overflow-y: auto;">
                                            <pre id="riskAnalysisContent" style="white-space: pre-wrap; font-family: inherit; margin: 0;">è«‹å…ˆé€²è¡Œåˆ†æ...</pre>
                                        </div>
                                        <div class="mt-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <strong>è©•åˆ†: </strong>
                                                <small class="text-muted">(+é¢¨éšªä½/-é¢¨éšªé«˜)</small>
                                            </div>
                                            <span id="riskScoreDisplay" class="fs-4 fw-bold">--</span>
                                            <div class="mt-2">
                                                <strong>å»ºè­°: </strong>
                                                <span id="riskComment" class="text-muted">--</span>
                                            </div>
                                            <button class="btn btn-sm btn-success w-100 mt-2" id="applyRiskScore">
                                                âœ… æ‡‰ç”¨é¢¨éšªé¢è©•åˆ†
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- åˆä½µè©•åˆ†å€åŸŸ -->
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header bg-primary text-white">
                                        <strong>ğŸ“Š ç¶œåˆåˆ†ææ‘˜è¦</strong>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-md-6">
                                                <h6>æ¶ˆæ¯é¢è©•åˆ†</h6>
                                                <div id="finalNewsScore" class="fs-1 fw-bold text-danger">--</div>
                                                <div id="finalNewsComment" class="text-muted">--</div>
                                                <small class="text-muted">(+åˆ©å¤š/-åˆ©ç©º)</small>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>é¢¨éšªé¢è©•åˆ†</h6>
                                                <div id="finalRiskScore" class="fs-1 fw-bold text-warning">--</div>
                                                <div id="finalRiskComment" class="text-muted">--</div>
                                            </div>
                                        </div>
                                        <div class="text-center mt-3">
                                            <button class="btn btn-primary" id="applyBothScores">
                                                âœ… åŒæ™‚æ‡‰ç”¨å…©é …è©•åˆ†
                                            </button>
                                            <small class="text-muted d-block mt-2">å°‡åŒæ™‚æ›´æ–°æ¶ˆæ¯é¢(10%)å’Œé¢¨éšªé¢(10%)çš„è©•åˆ†</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="text-center mb-4">
        <button class="btn btn-outline-light" type="button" data-bs-toggle="collapse" data-bs-target="#debugLog">
            é¡¯ç¤º/éš±è— é™¤éŒ¯æ—¥èªŒ
        </button>
    </div>

    <div class="collapse" id="debugLog">
        <div class="card mb-4">
            <div class="card-body p-3">
                <pre id="logContent" class="debug-log"></pre>
            </div>
            <div class="card-footer">
                <button class="btn btn-sm btn-outline-danger" onclick="document.getElementById('logContent').textContent = '';">æ¸…é™¤æ—¥èªŒ</button>
            </div>
        </div>
    </div>

    <div id="loading" class="text-center my-5" style="display:none;">
        <div class="spinner-border text-warning" style="width:6rem;height:6rem;"></div>
        <h3 class="mt-4">æ­£åœ¨æŠ“å–æœ€æ–°è³‡æ–™ (å¤šç¶­åº¦åˆ†æä¸­)â€¦</h3>
    </div>

    <div id="result" style="display:none;"></div>

</div>

<footer>Â© 2025 Joseph PAI. All Rights Reserved. | è³‡æ–™ä¾†æºï¼šå°ç£è­‰åˆ¸äº¤æ˜“æ‰€ (TWSE) + è­‰åˆ¸æ«ƒæª¯è²·è³£ä¸­å¿ƒ (TPEx) + FinMind + Yahoo Finance</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // ================= åˆå§‹åŒ–èˆ‡å…¨åŸŸè®Šæ•¸ =================
    let TOKEN = '';
    try { TOKEN = localStorage.getItem('joseph_pai_token_2025') || ''; } catch(e) {}

    // è²¡å‹™æ•¸æ“šç·©å­˜ - çµæ§‹åŒ–æ ¼å¼
    let financialCache = {
        eps: { quarters: {}, year: null },
        roe: { quarters: {}, year: null },
        revenueGrowth: { months: {}, quarters: {}, year: null },
        profitMargin: { quarters: {}, year: null },
        _metadata: { source: '', stock_id: '', last_updated: '' }
    };

    // å…¬å¸é¡å‹èˆ‡è‚¡ç¥¨æ•¸æ“š
    let currentCompanyType = 'auto'; // auto, listed, otc, emerging
    let detectedCompanyType = null; // listed, otc, emerging, null
    let stockData = {
        listed: [],    // ä¸Šå¸‚å…¬å¸æ•¸æ“š
        otc: [],       // ä¸Šæ«ƒå…¬å¸æ•¸æ“š
        emerging: []   // èˆˆæ«ƒå…¬å¸æ•¸æ“š
    };

    const twseIndustryMap = {
        "01": "æ°´æ³¥å·¥æ¥­", "02": "é£Ÿå“å·¥æ¥­", "03": "å¡‘è† å·¥æ¥­", "04": "ç´¡ç¹”çº–ç¶­", "05": "é›»æ©Ÿæ©Ÿæ¢°",
        "06": "é›»å™¨é›»çºœ", "07": "åŒ–å­¸ç”ŸæŠ€é†«ç™‚", "08": "ç»ç’ƒé™¶ç“·", "09": "é€ ç´™å·¥æ¥­", "10": "é‹¼éµå·¥æ¥­",
        "11": "æ©¡è† å·¥æ¥­", "12": "æ±½è»Šå·¥æ¥­", "13": "é›»å­å·¥æ¥­", "14": "å»ºæç‡Ÿé€ ", "15": "èˆªé‹æ¥­",
        "16": "è§€å…‰äº‹æ¥­", "17": "é‡‘èä¿éšª", "18": "è²¿æ˜“ç™¾è²¨", "19": "ç¶œåˆ", "20": "å…¶ä»–",
        "21": "åŒ–å­¸å·¥æ¥­", "22": "ç”ŸæŠ€é†«ç™‚æ¥­", "23": "æ²¹é›»ç‡ƒæ°£æ¥­", "24": "åŠå°é«”æ¥­", "25": "é›»è…¦åŠé€±é‚Šè¨­å‚™æ¥­",
        "26": "å…‰é›»æ¥­", "27": "é€šä¿¡ç¶²è·¯æ¥­", "28": "é›»å­é›¶çµ„ä»¶æ¥­", "29": "é›»å­é€šè·¯æ¥­", "30": "è³‡è¨Šæœå‹™æ¥­",
        "31": "å…¶ä»–é›»å­æ¥­", "32": "æ–‡åŒ–å‰µæ„æ¥­", "33": "è¾²æ¥­ç§‘æŠ€æ¥­", "34": "é›»å­å•†å‹™æ¥­",
        "35": "ç¶ èƒ½ç’°ä¿", "36": "æ•¸ä½é›²ç«¯", "37": "é‹å‹•ä¼‘é–’", "38": "å±…å®¶ç”Ÿæ´»", "91": "å­˜è¨—æ†‘è­‰"
    };

    // ç†±é–€è‚¡ç¥¨åˆ—è¡¨
    const hotStocks = [
        { code: '2330', name: 'å°ç©é›»', type: 'listed' },
        { code: '2454', name: 'è¯ç™¼ç§‘', type: 'listed' },
        { code: '2317', name: 'é´»æµ·', type: 'listed' },
        { code: '2412', name: 'ä¸­è¯é›»', type: 'listed' },
        { code: '2308', name: 'å°é”é›»', type: 'listed' },
        { code: '2882', name: 'åœ‹æ³°é‡‘', type: 'listed' },
        { code: '2881', name: 'å¯Œé‚¦é‡‘', type: 'listed' },
        { code: '1303', name: 'å—äº', type: 'listed' },
        { code: '1301', name: 'å°å¡‘', type: 'listed' },
        { code: '1326', name: 'å°åŒ–', type: 'listed' }
    ];

    // æœå°‹æ­·å²
    let searchHistory = [];

    // ================= åˆ†ææ­·å²ç®¡ç† =================
    let analysisHistory = {
        news: null,
        risk: null
    };

    // æ–°å¢ï¼šä¸¦è¡Œåˆ†æç‹€æ…‹ç®¡ç†
    let parallelAnalysisState = {
        news: { status: 'idle', result: null, timestamp: null },
        risk: { status: 'idle', result: null, timestamp: null }
    };

    // ================= æœå°‹æ­·å²ç®¡ç† =================
    
    // è¼‰å…¥æœå°‹æ­·å²
    function loadSearchHistory() {
        try {
            const savedHistory = localStorage.getItem('joseph_pai_search_history');
            if (savedHistory) {
                searchHistory = JSON.parse(savedHistory);
                updateQuickSearchSelect();
            }
        } catch (e) {
            console.error('è¼‰å…¥æœå°‹æ­·å²å¤±æ•—:', e);
            searchHistory = [];
        }
    }
    
    // å„²å­˜æœå°‹æ­·å²
    function saveSearchHistory(stockCode, stockName, companyType) {
        try {
            // ç§»é™¤å·²å­˜åœ¨çš„ç›¸åŒè¨˜éŒ„
            searchHistory = searchHistory.filter(item => item.code !== stockCode);
            
            // æ·»åŠ åˆ°é–‹é ­
            searchHistory.unshift({
                code: stockCode,
                name: stockName,
                type: companyType,
                timestamp: new Date().toISOString()
            });
            
            // åªä¿ç•™æœ€è¿‘20å€‹è¨˜éŒ„
            if (searchHistory.length > 20) {
                searchHistory = searchHistory.slice(0, 20);
            }
            
            localStorage.setItem('joseph_pai_search_history', JSON.stringify(searchHistory));
            updateQuickSearchSelect();
        } catch (e) {
            console.error('å„²å­˜æœå°‹æ­·å²å¤±æ•—:', e);
        }
    }
    
    // æ›´æ–°å¿«é€Ÿæœå°‹ä¸‹æ‹‰é¸å–®
    function updateQuickSearchSelect() {
        const quickSearchSelect = document.getElementById('quickSearchSelect');
        if (!quickSearchSelect) return;
        
        // å„²å­˜ç•¶å‰é¸ä¸­çš„å€¼
        const currentValue = quickSearchSelect.value;
        
        // æ¸…ç©ºé¸å–®
        quickSearchSelect.innerHTML = '<option value="">é¸æ“‡ç†±é–€è‚¡ç¥¨æˆ–æœå°‹è¨˜éŒ„...</option>';
        
        // æ·»åŠ æœå°‹æ­·å²
        if (searchHistory.length > 0) {
            const historyGroup = document.createElement('optgroup');
            historyGroup.label = 'æœ€è¿‘æœå°‹';
            
            searchHistory.forEach(item => {
                const option = document.createElement('option');
                option.value = item.code;
                option.textContent = `${item.code} ${item.name} (${item.type === 'listed' ? 'ä¸Šå¸‚' : item.type === 'otc' ? 'ä¸Šæ«ƒ' : 'èˆˆæ«ƒ'})`;
                option.dataset.type = item.type;
                historyGroup.appendChild(option);
            });
            
            quickSearchSelect.appendChild(historyGroup);
        }
        
        // æ·»åŠ ç†±é–€è‚¡ç¥¨
        const hotGroup = document.createElement('optgroup');
        hotGroup.label = 'ç†±é–€è‚¡ç¥¨';
        
        hotStocks.forEach(stock => {
            const option = document.createElement('option');
            option.value = stock.code;
            option.textContent = `${stock.code} ${stock.name}`;
            option.dataset.type = stock.type;
            hotGroup.appendChild(option);
        });
        
        quickSearchSelect.appendChild(hotGroup);
        
        // æ¢å¾©ä¹‹å‰é¸ä¸­çš„å€¼
        quickSearchSelect.value = currentValue;
    }

    // ä¿å­˜åˆ†ææ­·å²
    function saveAnalysisHistory(analysisType, result, stockName) {
        if (!result || !stockName) return;
        
        analysisHistory[analysisType] = {
            content: result.content || '',
            score: result.score || 0,
            comment: result.comment || '',
            timestamp: new Date().toISOString(),
            stockName: stockName,
            rawContent: result.rawContent || result.content || '',
            positives: result.positives || [],
            negatives: result.negatives || []
        };
        console.log(`å·²ä¿å­˜ ${analysisType} åˆ†ææ­·å²`);
    }

    // åŠ è¼‰ä¿å­˜çš„åˆ†ææ­·å²
    function loadAnalysisHistory(analysisType) {
        const history = analysisHistory[analysisType];
        if (history && history.timestamp) {
            // æª¢æŸ¥æ­·å²æ˜¯å¦éæœŸï¼ˆè¶…é1å°æ™‚ï¼‰
            const historyTime = new Date(history.timestamp);
            const now = new Date();
            const hoursDiff = (now - historyTime) / (1000 * 60 * 60);
            
            if (hoursDiff > 1) {
                console.log(`${analysisType} åˆ†ææ­·å²å·²éæœŸ`);
                return false;
            }
            
            // æ›´æ–°å°æ‡‰çš„åˆ†æçµæœé¡¯ç¤º
            if (analysisType === 'news') {
                document.getElementById('newsAnalysisContent').textContent = history.content;
                document.getElementById('newsScoreDisplay').textContent = 
                    history.score > 0 ? `+${history.score}` : history.score;
                document.getElementById('newsComment').textContent = history.comment;
                updateScoreDisplay(history.score, 'news', 'news');
            } else {
                document.getElementById('riskAnalysisContent').textContent = history.content;
                document.getElementById('riskScoreDisplay').textContent = 
                    history.score > 0 ? `+${history.score}` : history.score;
                document.getElementById('riskComment').textContent = history.comment;
                updateScoreDisplay(history.score, 'risk', 'risk');
            }
            
            console.log(`å·²è¼‰å…¥ ${analysisType} åˆ†ææ­·å²`);
            return true;
        }
        return false;
    }

    // ================= è¼¸å…¥é©—è­‰å‡½æ•¸ =================
    function validateStockCode(code) {
        if (!code || code.trim() === '') {
            return { valid: false, message: 'è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼' };
        }
        
        // æ¸…ç†è¼¸å…¥
        const cleaned = code.trim().toUpperCase();
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„è‚¡ç¥¨ä»£ç¢¼æ ¼å¼
        if (/^[0-9]{4}$/.test(cleaned)) {
            return { valid: true, code: cleaned, type: 'numeric' };
        }
        
        // æª¢æŸ¥æ˜¯å¦åŒ…å«å…¬å¸åç¨±
        if (/^[A-Za-z0-9]/.test(cleaned)) {
            return { valid: true, code: cleaned, type: 'mixed' };
        }
        
        return { valid: false, message: 'è‚¡ç¥¨ä»£ç¢¼æ ¼å¼ä¸æ­£ç¢º' };
    }

    function validateDateRange(startDate, endDate) {
        if (!startDate || !endDate) {
            return { valid: false, message: 'è«‹é¸æ“‡å®Œæ•´çš„æ—¥æœŸç¯„åœ' };
        }
        
        const start = new Date(startDate);
        const end = new Date(endDate);
        const today = new Date();
        
        if (isNaN(start.getTime()) || isNaN(end.getTime())) {
            return { valid: false, message: 'æ—¥æœŸæ ¼å¼ä¸æ­£ç¢º' };
        }
        
        if (start > end) {
            return { valid: false, message: 'é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ' };
        }
        
        if (end > today) {
            return { valid: false, message: 'çµæŸæ—¥æœŸä¸èƒ½è¶…éä»Šå¤©' };
        }
        
        // æª¢æŸ¥æ—¥æœŸç¯„åœæ˜¯å¦åˆç†ï¼ˆä¸è¶…é2å¹´ï¼‰
        const daysDiff = (end - start) / (1000 * 60 * 60 * 24);
        if (daysDiff > 730) {
            return { valid: false, message: 'åˆ†ææ™‚é–“ç¯„åœä¸èƒ½è¶…é2å¹´' };
        }
        
        return { valid: true };
    }

    function validateWeightInput(value, fieldName) {
        const numValue = parseInt(value);
        if (isNaN(numValue)) {
            return { valid: false, message: `${fieldName}å¿…é ˆæ˜¯æ•¸å­—` };
        }
        
        if (numValue < 0 || numValue > 100) {
            return { valid: false, message: `${fieldName}å¿…é ˆåœ¨0-100ä¹‹é–“` };
        }
        
        return { valid: true, value: numValue };
    }

    // ================= UI æ›´æ–°èˆ‡é©—è­‰é¡¯ç¤º =================
    function showValidationError(elementId, message) {
        const element = document.getElementById(elementId);
        if (element) {
            element.classList.add('validation-error');
            setTimeout(() => {
                element.classList.remove('validation-error');
            }, 3000);
            
            if (message) {
                log(`é©—è­‰éŒ¯èª¤: ${message}`);
                showToast(message, 'error');
            }
        }
    }

    function showToast(message, type = 'info') {
        // å‰µå»ºç°¡å–®çš„toasté€šçŸ¥
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <span>${message}</span>
                <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;
        document.body.appendChild(toast);
        
        // è‡ªå‹•ç§»é™¤
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 5000);
    }

    // ================= å…¬å¸é¡å‹è™•ç†å‡½æ•¸ =================
    
    // æ›´æ–°å…¬å¸é¡å‹é¡¯ç¤º
    function updateCompanyTypeDisplay(type, name = '') {
        const displayEl = document.getElementById('detectedTypeDisplay');
        if (!displayEl) return;
        
        let displayText = '';
        let className = '';
        
        if (type === 'listed') {
            displayText = `âœ… ä¸Šå¸‚å…¬å¸${name ? ': ' + name : ''}`;
            className = 'type-listed';
        } else if (type === 'otc') {
            displayText = `ğŸ“Š ä¸Šæ«ƒå…¬å¸${name ? ': ' + name : ''}`;
            className = 'type-listed';
        } else if (type === 'emerging') {
            displayText = `âš ï¸ èˆˆæ«ƒå…¬å¸${name ? ': ' + name : ''}`;
            className = 'type-emerging';
        } else if (type === 'unknown') {
            displayText = 'â“ æœªçŸ¥å…¬å¸é¡å‹';
            className = 'type-unknown';
        } else if (type === 'detecting') {
            displayText = 'ğŸ”„ æª¢æ¸¬ä¸­...';
            className = 'type-unknown';
        }
        
        displayEl.innerHTML = `<span class="${className}">${displayText}</span>`;
    }
    
    // æª¢æ¸¬å…¬å¸é¡å‹ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
    async function detectCompanyType(stockCode) {
        if (!stockCode || stockCode.trim() === '') {
            updateCompanyTypeDisplay('unknown');
            return { type: 'unknown', stock_name: '', suggestions: [] };
        }
        
        updateCompanyTypeDisplay('detecting');
        
        try {
            log(`é–‹å§‹æª¢æ¸¬å…¬å¸é¡å‹: ${stockCode}`);
            
            // ä½¿ç”¨æ–°çš„æª¢æ¸¬API
            const response = await fetch('/.netlify/functions/check-company-type', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    stock_code: stockCode.trim()
                })
            });
            
            if (!response.ok) {
                throw new Error(`APIéŒ¯èª¤: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.error) {
                log(`æª¢æ¸¬å¤±æ•—: ${result.error}`);
                updateCompanyTypeDisplay('unknown');
                return { type: 'unknown', stock_name: '', suggestions: [] };
            }
            
            log(`æª¢æ¸¬çµæœ: ${result.type} - ${result.stock_name}`);
            
            // æ›´æ–°é¡¯ç¤º
            detectedCompanyType = result.type;
            updateCompanyTypeDisplay(result.type, result.stock_name);
            
            // æ›´æ–°å…¬å¸é¡å‹é¸æ“‡æŒ‰éˆ•
            updateCompanyTypeSelection(result.type);
            
            // å¦‚æœæ‰¾åˆ°å…¬å¸ï¼Œæ›´æ–°è‚¡ç¥¨é¸æ“‡
            if (result.type !== 'not_found') {
                // ä¿å­˜åˆ°æœå°‹æ­·å²
                saveSearchHistory(result.stock_code || stockCode, result.stock_name, result.type);
                
                // æ›´æ–°æ•¸æ“šä¾†æºé¡¯ç¤º
                updateDataSourceInfo(result.type, result.source);
            }
            
            return result;
            
        } catch (error) {
            log(`æª¢æ¸¬å…¬å¸é¡å‹éŒ¯èª¤: ${error.message}`);
            updateCompanyTypeDisplay('unknown');
            return { type: 'unknown', stock_name: '', suggestions: [] };
        }
    }
    
    // æ›´æ–°å…¬å¸é¡å‹é¸æ“‡
    function updateCompanyTypeSelection(companyType) {
        const radioBtn = document.querySelector(`input[name="companyType"][value="${companyType}"]`);
        if (radioBtn) {
            radioBtn.checked = true;
            handleCompanyTypeChange(companyType);
        }
    }
    
    // æ›´æ–°æ•¸æ“šä¾†æºä¿¡æ¯
    function updateDataSourceInfo(companyType, source) {
        const sourceEl = document.getElementById('currentDataSource');
        if (!sourceEl) return;
        
        let sourceText = '';
        
        if (companyType === 'listed') {
            if (TOKEN) {
                sourceText = 'FinMind + TWSEå°ç£è­‰åˆ¸äº¤æ˜“æ‰€';
            } else {
                sourceText = 'TWSEå°ç£è­‰åˆ¸äº¤æ˜“æ‰€ (å…¬é–‹è³‡æ–™)';
            }
        } else if (companyType === 'otc') {
            sourceText = 'TPExè­‰åˆ¸æ«ƒæª¯è²·è³£ä¸­å¿ƒ (ä¸Šæ«ƒ)';
        } else if (companyType === 'emerging') {
            sourceText = 'TPExè­‰åˆ¸æ«ƒæª¯è²·è³£ä¸­å¿ƒ (èˆˆæ«ƒ)';
        } else {
            sourceText = 'æº–å‚™ä¸­...';
        }
        
        if (source) {
            sourceText += ` (${source})`;
        }
        
        sourceEl.textContent = sourceText;
    }
    
    // å…¬å¸é¡å‹é¸æ“‡è®ŠåŒ–è™•ç† - ä¿®å¾©ç‰ˆ
    function handleCompanyTypeChange(selectedType) {
        currentCompanyType = selectedType;
        
        log(`å…¬å¸é¡å‹è®Šæ›´ç‚º: ${selectedType}`);
        
        // æ›´æ–°UIç‹€æ…‹
        const stockCategory = document.getElementById('stockCategory');
        const categorySection = document.getElementById('categorySection');
        const listedStockSelect = document.getElementById('listedStockSelect');
        
        if (selectedType === 'listed' || selectedType === 'auto') {
            // ä¸Šå¸‚å…¬å¸æˆ–è‡ªå‹•æª¢æ¸¬ï¼šé¡¯ç¤ºé¡è‚¡é¸æ“‡
            if (stockCategory) {
                stockCategory.disabled = false;
            }
            if (categorySection) {
                categorySection.style.opacity = '1';
                categorySection.style.pointerEvents = 'auto';
            }
            if (listedStockSelect) {
                listedStockSelect.disabled = false;
            }
        } else {
            // ä¸Šæ«ƒ/èˆˆæ«ƒï¼šéš±è—é¡è‚¡é¸æ“‡
            if (stockCategory) {
                stockCategory.disabled = true;
                stockCategory.value = 'all';
            }
            if (categorySection) {
                categorySection.style.opacity = '0.5';
                categorySection.style.pointerEvents = 'none';
            }
            if (listedStockSelect) {
                listedStockSelect.disabled = true;
                listedStockSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡é¡è‚¡</option>';
            }
            
            // æ¸…é™¤è‚¡ç¥¨é¸æ“‡
            const stockSelect = document.getElementById('stockSelect');
            if (stockSelect) {
                stockSelect.innerHTML = '<option value="">è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼</option>';
                stockSelect.disabled = false;
            }
        }
        
        // æ›´æ–°æ•¸æ“šä¾†æºé¡¯ç¤º
        updateDataSourceInfo(selectedType === 'auto' ? null : selectedType);
        
        // æ¸…é™¤ç•¶å‰çš„æª¢æ¸¬çµæœ
        if (selectedType !== 'auto') {
            detectedCompanyType = null;
            updateCompanyTypeDisplay('unknown');
        }
        
        // æ›´æ–°è‚¡ç¥¨é¸æ“‡æ¸…å–®
        updateStockSelect();
        updateListedStockSelect();
    }

    // è¨­ç½®å…¬å¸é¡å‹é¸æ“‡ç›£è½å™¨
    document.querySelectorAll('input[name="companyType"]').forEach(radio => {
        radio.addEventListener('change', function() {
            handleCompanyTypeChange(this.value);
        });
    });

    // ================= é¡è‚¡é¸æ“‡è™•ç† =================
    
    // æ–°å¢ï¼šé¡è‚¡é¸æ“‡è®ŠåŒ–æ™‚ï¼Œè‡ªå‹•è¨­ç½®å…¬å¸é¡å‹ç‚ºä¸Šå¸‚å…¬å¸
    function handleStockCategoryChange() {
        const stockCategory = document.getElementById('stockCategory');
        if (!stockCategory) return;
        
        const selectedValue = stockCategory.value;
        
        if (selectedValue) {
            // ç•¶ç”¨æˆ¶é¸æ“‡äº†é¡è‚¡ï¼ˆåŒ…æ‹¬"å…¨éƒ¨é¡è‚¡"ï¼‰ï¼Œè‡ªå‹•è¨­ç½®ç‚ºä¸Šå¸‚å…¬å¸
            const listedRadio = document.getElementById('companyTypeListed');
            if (listedRadio && currentCompanyType !== 'listed') {
                listedRadio.checked = true;
                handleCompanyTypeChange('listed');
                log(`ç”¨æˆ¶é¸æ“‡é¡è‚¡ ${selectedValue}ï¼Œè‡ªå‹•è¨­ç½®å…¬å¸é¡å‹ç‚ºä¸Šå¸‚å…¬å¸`);
                showToast('å·²è‡ªå‹•è¨­ç½®ç‚ºä¸Šå¸‚å…¬å¸æ¨¡å¼', 'info');
            }
        }
        
        // æ›´æ–°ä¸Šå¸‚å…¬å¸é¸æ“‡æ¸…å–®
        updateListedStockSelect();
    }
    
    // è¨­ç½®é¡è‚¡é¸æ“‡ç›£è½å™¨
    document.getElementById('stockCategory').addEventListener('change', handleStockCategoryChange);
    
    // æ–°å¢ï¼šé»æ“Šé¡è‚¡ä¸‹æ‹‰é¸å–®æ™‚ï¼Œå¦‚æœå…¬å¸é¡å‹ä¸æ˜¯ä¸Šå¸‚å…¬å¸ï¼Œè‡ªå‹•è¨­ç½®
    document.getElementById('stockCategory').addEventListener('focus', function() {
        if (currentCompanyType !== 'listed') {
            // æç¤ºç”¨æˆ¶å°‡æœƒè‡ªå‹•åˆ‡æ›åˆ°ä¸Šå¸‚å…¬å¸æ¨¡å¼
            log('ç”¨æˆ¶é»æ“Šé¡è‚¡é¸æ“‡ï¼Œæº–å‚™è‡ªå‹•åˆ‡æ›åˆ°ä¸Šå¸‚å…¬å¸æ¨¡å¼');
        }
    });
    
    // æ–°å¢ï¼šé¡è‚¡ä¸‹æ‹‰é¸å–®é»æ“Šäº‹ä»¶
    document.getElementById('stockCategory').addEventListener('click', function() {
        if (currentCompanyType !== 'listed') {
            // ç”¨æˆ¶é»æ“Šä¸‹æ‹‰é¸å–®æ™‚ï¼Œå…ˆè¨­ç½®ç‚ºä¸Šå¸‚å…¬å¸æ¨¡å¼
            const listedRadio = document.getElementById('companyTypeListed');
            if (listedRadio) {
                listedRadio.checked = true;
                handleCompanyTypeChange('listed');
                log('ç”¨æˆ¶é»æ“Šé¡è‚¡ä¸‹æ‹‰é¸å–®ï¼Œè‡ªå‹•è¨­ç½®å…¬å¸é¡å‹ç‚ºä¸Šå¸‚å…¬å¸');
            }
        }
    });

    // ================= FinMind Token å„²å­˜åŠŸèƒ½ =================
    
    // å„²å­˜ Token æŒ‰éˆ•äº‹ä»¶
    document.getElementById('saveToken').addEventListener('click', function() {
        const tokenInput = document.getElementById('tokenInput');
        const tokenStatus = document.getElementById('tokenStatus');
        
        if (!tokenInput || !tokenStatus) return;
        
        const tokenValue = tokenInput.value.trim();
        
        if (!tokenValue) {
            // æ¸…é™¤ Token
            localStorage.removeItem('joseph_pai_token_2025');
            TOKEN = '';
            tokenStatus.innerHTML = '<span style="color:#ffc107">Token å·²æ¸…é™¤ï¼Œå°‡ä½¿ç”¨å…¬é–‹è³‡æ–™</span>';
            showToast('Token å·²æ¸…é™¤', 'info');
            log('FinMind Token å·²æ¸…é™¤');
        } else {
            // å„²å­˜ Token
            try {
                localStorage.setItem('joseph_pai_token_2025', tokenValue);
                TOKEN = tokenValue;
                
                // æ¸¬è©¦ Token æœ‰æ•ˆæ€§
                testFinMindToken(tokenValue, tokenStatus);
                
                showToast('Token å·²å„²å­˜', 'success');
                log('FinMind Token å·²å„²å­˜ä¸¦æ¸¬è©¦é€£ç·šä¸­...');
            } catch (e) {
                tokenStatus.innerHTML = '<span style="color:#dc3545">å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š</span>';
                showToast('Token å„²å­˜å¤±æ•—', 'error');
                log(`Token å„²å­˜å¤±æ•—: ${e.message}`);
            }
        }
    });
    
    // æ¸¬è©¦ FinMind Token æœ‰æ•ˆæ€§
    async function testFinMindToken(token, statusElement) {
        if (!statusElement) return;
        
        statusElement.innerHTML = '<span style="color:#ffc107">æ¸¬è©¦ FinMind é€£ç·šä¸­...</span>';
        
        try {
            const testUrl = `/.netlify/functions/fetch-finmind?dataset=TaiwanStockInfo&token=${token}`;
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            
            const response = await fetch(testUrl, { 
                signal: controller.signal 
            });
            clearTimeout(timeoutId);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.status === 200 && data.data) {
                statusElement.innerHTML = '<span style="color:#28a745">âœ“ FinMind Token æœ‰æ•ˆï¼Œé€£ç·šæˆåŠŸ</span>';
                log('FinMind Token æ¸¬è©¦æˆåŠŸ');
                
                // é‡æ–°è¼‰å…¥è‚¡ç¥¨æ•¸æ“š
                await loadStockData();
                updateStockSelect();
                updateListedStockSelect();
            } else {
                throw new Error('API è¿”å›ç„¡æ•ˆæ•¸æ“š');
            }
        } catch (error) {
            statusElement.innerHTML = `<span style="color:#dc3545">âœ— Token æ¸¬è©¦å¤±æ•—: ${error.message}</span>`;
            log(`FinMind Token æ¸¬è©¦å¤±æ•—: ${error.message}`);
            
            // ä½†ä»å…è¨±å„²å­˜ Tokenï¼Œå¯èƒ½åªæ˜¯æš«æ™‚é€£ç·šå•é¡Œ
            statusElement.innerHTML += '<br><small style="color:#ffc107">Token å·²å„²å­˜ï¼Œä½†é€£ç·šæ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦</small>';
        }
    }

    // ================= AI åˆ†æåŠŸèƒ½å¢å¼· =================
    
    // API å¹³å°éˆæ¥æ˜ å°„
    const apiPlatformLinks = {
        'deepseek': 'https://platform.deepseek.com/api_keys',
        'gpt': 'https://platform.openai.com/api-keys', 
        'gemini': 'https://aistudio.google.com/app/apikey',
        'claude': 'https://console.anthropic.com/settings/keys',
        'grok': 'https://console.x.ai/keys'
    };

    // API Key æ ¼å¼æç¤º
    const apiKeyHints = {
        'deepseek': 'DeepSeek API Key ä»¥ sk- é–‹é ­',
        'gpt': 'OpenAI API Key ä»¥ sk- é–‹é ­', 
        'gemini': 'Google AI Studio API Key',
        'claude': 'Claude API Key ä»¥ sk-ant- é–‹é ­',
        'grok': 'Grok API Key'
    };

    let currentAiApiKey = '';
    let currentAiPlatform = 'deepseek';
    let isAiKeyVerified = false;
    let aiConfig = {};

    // åŠ è¼‰ä¿å­˜çš„ AI è¨­ç½®
    function loadAiConfig() {
        try {
            const savedAiConfig = localStorage.getItem('joseph_pai_ai_config');
            if (savedAiConfig) {
                aiConfig = JSON.parse(savedAiConfig);
                
                // è¨­ç½®ç•¶å‰å¹³å°
                currentAiPlatform = aiConfig.currentPlatform || 'deepseek';
                const platformSelect = document.getElementById('aiPlatform');
                if (platformSelect) {
                    platformSelect.value = currentAiPlatform;
                }
                
                // åŠ è¼‰ç•¶å‰å¹³å°çš„ API Key
                const platformApiKey = aiConfig[`${currentAiPlatform}_apiKey`] || '';
                const apiKeyInput = document.getElementById('aiApiKey');
                if (apiKeyInput) {
                    apiKeyInput.value = platformApiKey;
                }
                currentAiApiKey = platformApiKey;
                
                // æ›´æ–°é©—è­‰ç‹€æ…‹
                isAiKeyVerified = aiConfig[`${currentAiPlatform}_verified`] || false;
                updateAiButtonState();
                
                // æ›´æ–°æç¤º
                const hint = apiKeyHints[currentAiPlatform] || 'è«‹è¼¸å…¥æœ‰æ•ˆçš„API Key';
                const apiKeyHint = document.getElementById('apiKeyHint');
                if (apiKeyHint) {
                    apiKeyHint.textContent = hint;
                }
                
                log(`âœ… å·²è¼‰å…¥ ${currentAiPlatform} API é…ç½®`);
            } else {
                aiConfig = {};
            }
        } catch (e) {
            console.error('åŠ è¼‰AIé…ç½®å¤±æ•—:', e);
            aiConfig = {};
        }
    }

    // ä¿å­˜ AI é…ç½®
    function saveAiConfig(platform, apiKey, verified = false) {
        try {
            aiConfig.currentPlatform = platform;
            aiConfig[`${platform}_apiKey`] = apiKey;
            aiConfig[`${platform}_verified`] = verified;
            
            localStorage.setItem('joseph_pai_ai_config', JSON.stringify(aiConfig));
            log(`âœ… å·²ä¿å­˜ ${platform} API é…ç½®`);
        } catch (e) {
            console.error('ä¿å­˜AIé…ç½®å¤±æ•—:', e);
            log(`âŒ ä¿å­˜AIé…ç½®å¤±æ•—: ${e.message}`);
        }
    }

    // ç²å–æŒ‡å®šå¹³å°çš„ API Key
    function getPlatformApiKey(platform) {
        return aiConfig[`${platform}_apiKey`] || '';
    }

    // æ¸…é™¤å¹³å°é©—è­‰ç‹€æ…‹
    function clearPlatformVerification(platform) {
        if (aiConfig[`${platform}_verified`]) {
            aiConfig[`${platform}_verified`] = false;
            localStorage.setItem('joseph_pai_ai_config', JSON.stringify(aiConfig));
        }
    }

    // å¹³å°è®ŠåŒ–æ™‚æ›´æ–°æç¤ºå’Œ API Key
    document.getElementById('aiPlatform').addEventListener('change', function() {
        const newPlatform = this.value;
        
        // æ¸…é™¤èˆŠå¹³å°çš„é©—è­‰ç‹€æ…‹
        clearPlatformVerification(currentAiPlatform);
        
        currentAiPlatform = newPlatform;
        
        // åŠ è¼‰æ–°å¹³å°çš„ API Key
        const platformApiKey = getPlatformApiKey(newPlatform);
        const apiKeyInput = document.getElementById('aiApiKey');
        if (apiKeyInput) {
            apiKeyInput.value = platformApiKey;
        }
        currentAiApiKey = platformApiKey;
        
        // æ›´æ–°é©—è­‰ç‹€æ…‹
        const hint = apiKeyHints[newPlatform] || 'è«‹è¼¸å…¥æœ‰æ•ˆçš„API Key';
        const apiKeyHint = document.getElementById('apiKeyHint');
        if (apiKeyHint) {
            apiKeyHint.textContent = hint;
        }
        
        // é‡ç½®é©—è­‰ç‹€æ…‹
        isAiKeyVerified = false;
        updateAiButtonState();
        
        const aiKeyStatus = document.getElementById('aiKeyStatus');
        if (aiKeyStatus) {
            aiKeyStatus.innerHTML = '<span class="badge bg-info">å·²åˆ‡æ›å¹³å°</span>';
        }
        
        log(`ğŸ”„ åˆ‡æ›åˆ° ${newPlatform} å¹³å°`);
    });

    // ç²å–APIéˆæ¥
    document.getElementById('getApiLink').addEventListener('click', function(e) {
        e.preventDefault();
        const platform = document.getElementById('aiPlatform').value;
        const url = apiPlatformLinks[platform];
        if (url) {
            window.open(url, '_blank');
        }
    });

    // API Key è¼¸å…¥è®ŠåŒ–
    document.getElementById('aiApiKey').addEventListener('input', function() {
        currentAiApiKey = this.value.trim();
        updateAiButtonState();
        
        // æ¸…é™¤é©—è­‰ç‹€æ…‹
        if (currentAiApiKey === '') {
            const aiKeyStatus = document.getElementById('aiKeyStatus');
            if (aiKeyStatus) {
                aiKeyStatus.innerHTML = '';
            }
            isAiKeyVerified = false;
        }
    });

    // æ”¹é€²çš„ API Key é©—è­‰
    document.getElementById('verifyAiKey').addEventListener('click', async function() {
        if (!currentAiApiKey) {
            showToast('è«‹è¼¸å…¥ API Key', 'error');
            return;
        }

        const verifyBtn = this;
        const originalText = verifyBtn.innerHTML;
        verifyBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>é©—è­‰ä¸­...';
        verifyBtn.disabled = true;

        try {
            // åŸºç¤æ ¼å¼é©—è­‰
            let formatValid = true;
            let formatMessage = '';
            
            if ((currentAiPlatform === 'gpt' || currentAiPlatform === 'deepseek') && !currentAiApiKey.startsWith('sk-')) {
                formatValid = false;
                formatMessage = 'API Key æ ¼å¼ä¸æ­£ç¢ºï¼Œæ‡‰è©²ä»¥ sk- é–‹é ­';
            }
            if (currentAiPlatform === 'claude' && !currentAiApiKey.startsWith('sk-ant-')) {
                formatValid = false;
                formatMessage = 'Claude API Key æ ¼å¼ä¸æ­£ç¢ºï¼Œæ‡‰è©²ä»¥ sk-ant- é–‹é ­';
            }
            
            if (!formatValid) {
                throw new Error(formatMessage);
            }

            // ä¿å­˜é…ç½®åˆ°æœ¬åœ°å­˜å„²
            saveAiConfig(currentAiPlatform, currentAiApiKey, true);
            
            isAiKeyVerified = true;
            updateAiButtonState();
            
            const aiKeyStatus = document.getElementById('aiKeyStatus');
            if (aiKeyStatus) {
                aiKeyStatus.innerHTML = '<span class="badge bg-success">âœ“ æ ¼å¼é©—è­‰æˆåŠŸ</span>';
            }
            
            log(`âœ… ${currentAiPlatform} API Key æ ¼å¼é©—è­‰æˆåŠŸä¸¦å·²ä¿å­˜`);
            showToast('API Key æ ¼å¼é©—è­‰æˆåŠŸ', 'success');
            
        } catch (error) {
            const aiKeyStatus = document.getElementById('aiKeyStatus');
            if (aiKeyStatus) {
                aiKeyStatus.innerHTML = '<span class="badge bg-danger">âœ— é©—è­‰å¤±æ•—</span>';
            }
            log(`âŒ API Key é©—è­‰å¤±æ•—: ${error.message}`);
            showToast(`é©—è­‰å¤±æ•—: ${error.message}`, 'error');
        } finally {
            verifyBtn.innerHTML = originalText;
            verifyBtn.disabled = false;
        }
    });

    // æ¸¬è©¦é€£ç·šæŒ‰éˆ•
    document.getElementById('testConnectionBtn').addEventListener('click', async function() {
        if (!currentAiApiKey) {
            showToast('è«‹å…ˆè¼¸å…¥ API Key', 'error');
            return;
        }

        const testBtn = this;
        const originalText = testBtn.innerHTML;
        testBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>æ¸¬è©¦ä¸­...';
        testBtn.disabled = true;

        try {
            log(`æ¸¬è©¦ ${currentAiPlatform} API é€£ç·š...`);
            
            const response = await fetch('/.netlify/functions/fetch-ai-analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    stockId: '2330',
                    stockName: 'å°ç©é›»',
                    apiKey: currentAiApiKey,
                    analysisType: 'news',
                    platform: currentAiPlatform
                })
            });

            const result = await response.json();
            
            if (result.error) {
                throw new Error(result.error);
            }

            // å¦‚æœæ¸¬è©¦æˆåŠŸï¼Œä¿å­˜é©—è­‰ç‹€æ…‹
            saveAiConfig(currentAiPlatform, currentAiApiKey, true);
            isAiKeyVerified = true;
            updateAiButtonState();
            
            const aiKeyStatus = document.getElementById('aiKeyStatus');
            if (aiKeyStatus) {
                aiKeyStatus.innerHTML = '<span class="badge bg-success">âœ“ é€£ç·šæ­£å¸¸</span>';
            }
            log(`âœ… ${currentAiPlatform} API é€£ç·šæ¸¬è©¦æˆåŠŸ`);
            showToast(`âœ… ${currentAiPlatform} API é€£ç·šæ­£å¸¸ï¼`, 'success');
            
        } catch (error) {
            const aiKeyStatus = document.getElementById('aiKeyStatus');
            if (aiKeyStatus) {
                aiKeyStatus.innerHTML = `<span class="badge bg-danger">âœ— é€£ç·šå¤±æ•—</span>`;
            }
            log(`âŒ API é€£ç·šæ¸¬è©¦å¤±æ•—: ${error.message}`);
            showToast(`âŒ é€£ç·šå¤±æ•—: ${error.message}`, 'error');
        } finally {
            testBtn.innerHTML = originalText;
            testBtn.disabled = false;
        }
    });

    // æ›´æ–° AI æŒ‰éˆ•ç‹€æ…‹
    function updateAiButtonState() {
        const analyzeBtn = document.getElementById('aiAnalyzeBtn');
        const singleNewsBtn = document.getElementById('singleNewsAnalysis');
        const singleRiskBtn = document.getElementById('singleRiskAnalysis');
        
        if (analyzeBtn) analyzeBtn.disabled = !currentAiApiKey;
        if (singleNewsBtn) singleNewsBtn.disabled = !currentAiApiKey;
        if (singleRiskBtn) singleRiskBtn.disabled = !currentAiApiKey;
        
        const aiKeyStatus = document.getElementById('aiKeyStatus');
        if (!aiKeyStatus) return;
        
        if (isAiKeyVerified && currentAiApiKey) {
            aiKeyStatus.innerHTML = '<span class="badge bg-success">âœ“ å·²é©—è­‰</span>';
        } else if (currentAiApiKey) {
            aiKeyStatus.innerHTML = '<span class="badge bg-warning">å¾…é©—è­‰</span>';
        } else {
            aiKeyStatus.innerHTML = '<span class="badge bg-secondary">æœªè¨­å®š</span>';
        }
    }

    // ================= ä¸¦è¡Œåˆ†æé€²åº¦æ§åˆ¶ =================
    function updateParallelProgress(newsProgress, riskProgress, newsStatus, riskStatus) {
        const progressBar = document.getElementById('parallelProgress');
        const newsProgressBar = document.getElementById('newsProgress');
        const riskProgressBar = document.getElementById('riskProgress');
        const newsStatusText = document.getElementById('newsStatus');
        const riskStatusText = document.getElementById('riskStatus');
        
        if (!progressBar || !newsProgressBar || !riskProgressBar || !newsStatusText || !riskStatusText) return;
        
        // é¡¯ç¤ºé€²åº¦æ¢
        progressBar.style.display = 'block';
        
        // æ›´æ–°é€²åº¦
        newsProgressBar.style.width = `${Math.min(100, Math.max(0, newsProgress))}%`;
        riskProgressBar.style.width = `${Math.min(100, Math.max(0, riskProgress))}%`;
        
        // æ›´æ–°ç‹€æ…‹æ–‡å­—
        newsStatusText.textContent = newsStatus;
        riskStatusText.textContent = riskStatus;
        
        // æ ¹æ“šç‹€æ…‹æ›´æ–°é¡è‰²
        if (newsStatus.includes('æˆåŠŸ') || newsStatus.includes('å®Œæˆ')) {
            newsProgressBar.className = 'progress-bar bg-success';
        } else if (newsStatus.includes('å¤±æ•—')) {
            newsProgressBar.className = 'progress-bar bg-danger';
        } else {
            newsProgressBar.className = 'progress-bar bg-danger';
        }
        
        if (riskStatus.includes('æˆåŠŸ') || riskStatus.includes('å®Œæˆ')) {
            riskProgressBar.className = 'progress-bar bg-success';
        } else if (riskStatus.includes('å¤±æ•—')) {
            riskProgressBar.className = 'progress-bar bg-danger';
        } else {
            riskProgressBar.className = 'progress-bar bg-warning';
        }
    }
    
    function resetParallelProgress() {
        const progressBar = document.getElementById('parallelProgress');
        if (progressBar) {
            progressBar.style.display = 'none';
        }
        
        // é‡ç½®ç‹€æ…‹
        parallelAnalysisState = {
            news: { status: 'idle', result: null, timestamp: null },
            risk: { status: 'idle', result: null, timestamp: null }
        };
    }

    function cleanupParallelAnalysis() {
        resetParallelProgress();
        analysisHistory.news = null;
        analysisHistory.risk = null;
    }

    // ================= ä¸¦è¡Œé›™é‡åˆ†æåŠŸèƒ½ =================
    document.getElementById('aiAnalyzeBtn').addEventListener('click', async function() {
        await performParallelAnalysis();
    });
    
    // å–®ç¨æ¶ˆæ¯é¢åˆ†æ
    document.getElementById('singleNewsAnalysis').addEventListener('click', async function() {
        await performSingleAnalysis('news');
    });
    
    // å–®ç¨é¢¨éšªé¢åˆ†æ
    document.getElementById('singleRiskAnalysis').addEventListener('click', async function() {
        await performSingleAnalysis('risk');
    });
    
    // åŸ·è¡Œä¸¦è¡Œåˆ†æ
    async function performParallelAnalysis() {
        // ç²å–è‚¡ç¥¨è³‡è¨Š
        const stockSelect = document.getElementById('stockSelect');
        const listedStockSelect = document.getElementById('listedStockSelect');
        
        let symbol = '';
        let stockName = '';
        
        // ç¢ºå®šä½¿ç”¨å“ªå€‹æ–¹å¼ç²å–è‚¡ç¥¨ä»£ç¢¼
        // é¦–å…ˆæª¢æŸ¥ä¸Šå¸‚å…¬å¸é¸æ“‡æ¸…å–®
        if (listedStockSelect && listedStockSelect.value) {
            // ä½¿ç”¨ä¸Šå¸‚å…¬å¸æ¸…å–®é¸æ“‡
            symbol = listedStockSelect.value.trim();
            
            // å¾é¸é …ä¸­ç²å–è‚¡ç¥¨åç¨±
            const selectedOption = listedStockSelect.options[listedStockSelect.selectedIndex];
            if (selectedOption && selectedOption.textContent) {
                const text = selectedOption.textContent.trim();
                const match = text.match(/^\d+\s+(.+)$/);
                stockName = match ? match[1] : text;
            }
        } 
        // ç„¶å¾Œæª¢æŸ¥ä¸»è‚¡ç¥¨é¸æ“‡æ¸…å–®
        else if (stockSelect && stockSelect.value) {
            // ä½¿ç”¨ä¸»æ¸…å–®é¸æ“‡
            symbol = stockSelect.value.trim();
            
            // å¾é¸é …ä¸­ç²å–è‚¡ç¥¨åç¨±
            const selectedOption = stockSelect.options[stockSelect.selectedIndex];
            if (selectedOption && selectedOption.textContent) {
                const text = selectedOption.textContent.trim();
                const match = text.match(/^\d+\s+(.+)$/);
                stockName = match ? match[1] : text;
            }
        }
        
        if (!symbol) {
            showToast('è«‹å…ˆé¸æ“‡è‚¡ç¥¨', 'error');
            return;
        }

        if (!currentAiApiKey) {
            showToast('è«‹å…ˆè¼¸å…¥ API Key', 'error');
            return;
        }

        const analyzeBtn = document.getElementById('aiAnalyzeBtn');
        const spinner = document.getElementById('aiSpinner');
        
        if (analyzeBtn) analyzeBtn.disabled = true;
        if (spinner) spinner.style.display = 'inline-block';
        
        // é¡¯ç¤ºç•¶å‰ä½¿ç”¨çš„å¹³å°
        const aiKeyStatus = document.getElementById('aiKeyStatus');
        if (aiKeyStatus) {
            aiKeyStatus.innerHTML = `<span class="badge bg-info">ğŸ”„ ${currentAiPlatform} ä¸¦è¡Œåˆ†æä¸­... (ç´„30ç§’)</span>`;
        }
        
        // æ¸…ç†ä¹‹å‰çš„åˆ†æçµæœ
        cleanupParallelAnalysis();
        updateParallelProgress(0, 0, 'ğŸ”„ æº–å‚™é–‹å§‹...', 'ğŸ”„ æº–å‚™é–‹å§‹...');
        
        try {
            log(`é–‹å§‹ä¸¦è¡Œåˆ†æ: ${symbol} ${stockName}, å¹³å°: ${currentAiPlatform}`);
            
            // å‰µå»ºå…©å€‹åˆ†æè«‹æ±‚
            const newsRequest = analyzeSingle(symbol, stockName, currentAiApiKey, 'news', true);
            const riskRequest = analyzeSingle(symbol, stockName, currentAiApiKey, 'risk', true);
            
            // æ›´æ–°é€²åº¦
            updateParallelProgress(30, 30, 'ğŸ”„ ç™¼é€æ¶ˆæ¯é¢è«‹æ±‚...', 'ğŸ”„ ç™¼é€é¢¨éšªé¢è«‹æ±‚...');
            
            // åŒæ™‚ç™¼é€å…©å€‹è«‹æ±‚
            const [newsResult, riskResult] = await Promise.allSettled([newsRequest, riskRequest]);
            
            // è™•ç†æ¶ˆæ¯é¢çµæœ
            if (newsResult.status === 'fulfilled') {
                updateParallelProgress(100, 50, 'âœ… æ¶ˆæ¯é¢åˆ†æå®Œæˆ', 'ğŸ”„ è™•ç†é¢¨éšªé¢çµæœ...');
                displayAnalysisResult(newsResult.value, 'news', stockName);
                parallelAnalysisState.news = { 
                    status: 'completed', 
                    result: newsResult.value,
                    timestamp: new Date().toISOString()
                };
            } else {
                updateParallelProgress(100, 50, 'âŒ æ¶ˆæ¯é¢åˆ†æå¤±æ•—', 'ğŸ”„ è™•ç†é¢¨éšªé¢çµæœ...');
                log(`âŒ æ¶ˆæ¯é¢åˆ†æå¤±æ•—: ${newsResult.reason}`);
                const newsContent = document.getElementById('newsAnalysisContent');
                if (newsContent) {
                    newsContent.textContent = `åˆ†æå¤±æ•—: ${newsResult.reason}`;
                }
                parallelAnalysisState.news = { 
                    status: 'failed', 
                    result: null,
                    timestamp: new Date().toISOString()
                };
            }
            
            // è™•ç†é¢¨éšªé¢çµæœ
            if (riskResult.status === 'fulfilled') {
                updateParallelProgress(100, 100, parallelAnalysisState.news.status === 'completed' ? 'âœ… æ¶ˆæ¯é¢åˆ†æå®Œæˆ' : 'âŒ æ¶ˆæ¯é¢åˆ†æå¤±æ•—', 'âœ… é¢¨éšªé¢åˆ†æå®Œæˆ');
                displayAnalysisResult(riskResult.value, 'risk', stockName);
                parallelAnalysisState.risk = { 
                    status: 'completed', 
                    result: riskResult.value,
                    timestamp: new Date().toISOString()
                };
            } else {
                updateParallelProgress(100, 100, parallelAnalysisState.news.status === 'completed' ? 'âœ… æ¶ˆæ¯é¢åˆ†æå®Œæˆ' : 'âŒ æ¶ˆæ¯é¢åˆ†æå¤±æ•—', 'âŒ é¢¨éšªé¢åˆ†æå¤±æ•—');
                log(`âŒ é¢¨éšªé¢åˆ†æå¤±æ•—: ${riskResult.reason}`);
                const riskContent = document.getElementById('riskAnalysisContent');
                if (riskContent) {
                    riskContent.textContent = `åˆ†æå¤±æ•—: ${riskResult.reason}`;
                }
                parallelAnalysisState.risk = { 
                    status: 'failed', 
                    result: null,
                    timestamp: new Date().toISOString()
                };
            }
            
            // é¡¯ç¤ºçµæœå€åŸŸ
            const aiAnalysisResult = document.getElementById('aiAnalysisResult');
            if (aiAnalysisResult) {
                aiAnalysisResult.style.display = 'block';
            }
            
            // æ›´æ–°ç¶œåˆæ‘˜è¦
            updateSummaryDisplay();
            
            if (aiKeyStatus) {
                aiKeyStatus.innerHTML = `<span class="badge bg-success">âœ… ${currentAiPlatform} ä¸¦è¡Œåˆ†æå®Œæˆ</span>`;
            }
            
            log(`âœ… ${currentAiPlatform} ä¸¦è¡Œåˆ†æå®Œæˆ`);
            showToast('ä¸¦è¡Œåˆ†æå®Œæˆ', 'success');
            
        } catch (error) {
            if (aiKeyStatus) {
                aiKeyStatus.innerHTML = `<span class="badge bg-danger">âœ— ${currentAiPlatform} åˆ†æå¤±æ•—</span>`;
            }
            log(`âŒ ä¸¦è¡Œåˆ†æå¤±æ•—: ${error.message}`);
            showToast(`ä¸¦è¡Œåˆ†æå¤±æ•—: ${error.message}`, 'error');
        } finally {
            if (analyzeBtn) analyzeBtn.disabled = false;
            if (spinner) spinner.style.display = 'none';
        }
    }
    
    // åŸ·è¡Œå–®ä¸€åˆ†æ
    async function performSingleAnalysis(analysisType) {
        // ç²å–è‚¡ç¥¨è³‡è¨Š
        const stockSelect = document.getElementById('stockSelect');
        const listedStockSelect = document.getElementById('listedStockSelect');
        
        let symbol = '';
        let stockName = '';
        
        // ç¢ºå®šä½¿ç”¨å“ªå€‹æ–¹å¼ç²å–è‚¡ç¥¨ä»£ç¢¼
        // é¦–å…ˆæª¢æŸ¥ä¸Šå¸‚å…¬å¸é¸æ“‡æ¸…å–®
        if (listedStockSelect && listedStockSelect.value) {
            // ä½¿ç”¨ä¸Šå¸‚å…¬å¸æ¸…å–®é¸æ“‡
            symbol = listedStockSelect.value.trim();
            
            // å¾é¸é …ä¸­ç²å–è‚¡ç¥¨åç¨±
            const selectedOption = listedStockSelect.options[listedStockSelect.selectedIndex];
            if (selectedOption && selectedOption.textContent) {
                const text = selectedOption.textContent.trim();
                const match = text.match(/^\d+\s+(.+)$/);
                stockName = match ? match[1] : text;
            }
        } 
        // ç„¶å¾Œæª¢æŸ¥ä¸»è‚¡ç¥¨é¸æ“‡æ¸…å–®
        else if (stockSelect && stockSelect.value) {
            // ä½¿ç”¨ä¸»æ¸…å–®é¸æ“‡
            symbol = stockSelect.value.trim();
            
            // å¾é¸é …ä¸­ç²å–è‚¡ç¥¨åç¨±
            const selectedOption = stockSelect.options[stockSelect.selectedIndex];
            if (selectedOption && selectedOption.textContent) {
                const text = selectedOption.textContent.trim();
                const match = text.match(/^\d+\s+(.+)$/);
                stockName = match ? match[1] : text;
            }
        }
        
        if (!symbol) {
            showToast('è«‹å…ˆé¸æ“‡è‚¡ç¥¨', 'error');
            return;
        }

        if (!currentAiApiKey) {
            showToast('è«‹å…ˆè¼¸å…¥ API Key', 'error');
            return;
        }

        const buttonId = analysisType === 'news' ? 'singleNewsAnalysis' : 'singleRiskAnalysis';
        const analyzeBtn = document.getElementById(buttonId);
        
        if (analyzeBtn) analyzeBtn.disabled = true;
        
        const aiKeyStatus = document.getElementById('aiKeyStatus');
        if (aiKeyStatus) {
            aiKeyStatus.innerHTML = `<span class="badge bg-info">ğŸ”„ ${currentAiPlatform} ${analysisType === 'news' ? 'æ¶ˆæ¯é¢' : 'é¢¨éšªé¢'}åˆ†æä¸­...</span>`;
        }
        
        try {
            log(`é–‹å§‹å–®ä¸€åˆ†æ (${analysisType}): ${symbol} ${stockName}, å¹³å°: ${currentAiPlatform}`);
            
            const result = await analyzeSingle(symbol, stockName, currentAiApiKey, analysisType, false);
            
            displayAnalysisResult(result, analysisType, stockName);
            
            // é¡¯ç¤ºçµæœå€åŸŸ
            const aiAnalysisResult = document.getElementById('aiAnalysisResult');
            if (aiAnalysisResult) {
                aiAnalysisResult.style.display = 'block';
            }
            
            // æ›´æ–°ç¶œåˆæ‘˜è¦
            updateSummaryDisplay();
            
            if (aiKeyStatus) {
                aiKeyStatus.innerHTML = `<span class="badge bg-success">âœ… ${analysisType === 'news' ? 'æ¶ˆæ¯é¢' : 'é¢¨éšªé¢'}åˆ†æå®Œæˆ</span>`;
            }
            
            log(`âœ… ${analysisType === 'news' ? 'æ¶ˆæ¯é¢' : 'é¢¨éšªé¢'}åˆ†æå®Œæˆ`);
            showToast(`${analysisType === 'news' ? 'æ¶ˆæ¯é¢' : 'é¢¨éšªé¢'}åˆ†æå®Œæˆ`, 'success');
            
        } catch (error) {
            if (aiKeyStatus) {
                aiKeyStatus.innerHTML = `<span class="badge bg-danger">âœ— ${analysisType === 'news' ? 'æ¶ˆæ¯é¢' : 'é¢¨éšªé¢'}åˆ†æå¤±æ•—</span>`;
            }
            log(`âŒ ${analysisType === 'news' ? 'æ¶ˆæ¯é¢' : 'é¢¨éšªé¢'}åˆ†æå¤±æ•—: ${error.message}`);
            showToast(`${analysisType === 'news' ? 'æ¶ˆæ¯é¢' : 'é¢¨éšªé¢'}åˆ†æå¤±æ•—: ${error.message}`, 'error');
        } finally {
            if (analyzeBtn) analyzeBtn.disabled = false;
        }
    }
    
    // å–®ä¸€åˆ†ææ ¸å¿ƒå‡½æ•¸
    async function analyzeSingle(stockId, stockName, apiKey, analysisType, isParallel = false) {
        try {
            const response = await fetch('/.netlify/functions/fetch-ai-analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    stockId: stockId,
                    stockName: stockName,
                    apiKey: apiKey,
                    analysisType: analysisType,
                    platform: currentAiPlatform,
                    isParallelRequest: isParallel
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP ${response.status}`);
            }

            const result = await response.json();
            
            if (result.error) {
                throw new Error(result.error);
            }

            return result;
            
        } catch (error) {
            throw error;
        }
    }
    
    // é¡¯ç¤ºåˆ†æçµæœåˆ°å°æ‡‰å€å¡Š
    function displayAnalysisResult(result, analysisType, stockName) {
        if (!result || !stockName) {
            log(`ç„¡æ³•é¡¯ç¤ºåˆ†æçµæœ: ç¼ºå°‘å¿…è¦æ•¸æ“š`);
            return;
        }
        
        const prefix = analysisType === 'news' ? 'news' : 'risk';
        
        // æ›´æ–°å…§å®¹
        const contentEl = document.getElementById(`${prefix}AnalysisContent`);
        if (contentEl) {
            contentEl.textContent = result.content || 'åˆ†æå…§å®¹ç‚ºç©º';
        }
        
        // æ›´æ–°è©•åˆ†é¡¯ç¤º
        const score = result.score || 0;
        updateScoreDisplay(score, analysisType, prefix);
        
        // æ›´æ–°å»ºè­°
        const commentEl = document.getElementById(`${prefix}Comment`);
        if (commentEl) {
            commentEl.textContent = result.comment || 'ç„¡å»ºè­°';
        }
        
        // æ›´æ–°åˆ†æ•¸å¾½ç« 
        const scoreBadge = document.getElementById(`${prefix}ScoreBadge`);
        if (scoreBadge) {
            scoreBadge.textContent = `${score > 0 ? '+' : ''}${score}/10`;
            scoreBadge.className = `badge ${score > 0 ? 'bg-success' : 'bg-secondary'} text-white`;
        }
        
        // ä¿å­˜åˆ†ææ­·å²
        saveAnalysisHistory(analysisType, result, stockName);
        
        // æ›´æ–°ç¶œåˆæ‘˜è¦ä¸­çš„å°æ‡‰éƒ¨åˆ†
        updateSummaryItem(analysisType, score, result.comment);
    }
    
    // æ›´æ–°è©•åˆ†é¡¯ç¤ºé¡è‰²
    function updateScoreDisplay(score, analysisType, prefix) {
        const scoreDisplay = document.getElementById(`${prefix}ScoreDisplay`);
        if (!scoreDisplay) return;
        
        const scoreValue = score > 0 ? `+${score}` : score;
        
        if (analysisType === 'news') {
            // æ¶ˆæ¯é¢ï¼š+åˆ†ç´…è‰²ï¼Œ-åˆ†é»‘è‰²
            scoreDisplay.className = 'fs-4 fw-bold ' + 
                (score > 0 ? 'text-danger' : 'text-dark');
        } else {
            // é¢¨éšªé¢ï¼šä¿æŒåŸæœ‰é¡è‰²é‚è¼¯
            scoreDisplay.className = 'fs-4 fw-bold ' + 
                (score > 0 ? 'text-success' : 
                 score < 0 ? 'text-danger' : 'text-warning');
        }
        
        scoreDisplay.textContent = scoreValue;
    }
    
    // æ›´æ–°ç¶œåˆæ‘˜è¦
    function updateSummaryDisplay() {
        const newsScore = parallelAnalysisState.news.result?.score || 0;
        const riskScore = parallelAnalysisState.risk.result?.score || 0;
        const newsComment = parallelAnalysisState.news.result?.comment || 'æœªåˆ†æ';
        const riskComment = parallelAnalysisState.risk.result?.comment || 'æœªåˆ†æ';
        
        updateSummaryItem('news', newsScore, newsComment);
        updateSummaryItem('risk', riskScore, riskComment);
    }
    
    function updateSummaryItem(analysisType, score, comment) {
        const prefix = analysisType === 'news' ? 'finalNews' : 'finalRisk';
        const scoreElement = document.getElementById(`${prefix}Score`);
        const commentElement = document.getElementById(`${prefix}Comment`);
        
        if (!scoreElement || !commentElement) return;
        
        const scoreValue = score !== 0 ? (score > 0 ? `+${score}` : score) : '--';
        
        if (analysisType === 'news') {
            scoreElement.className = 'fs-1 fw-bold ' + 
                (score > 0 ? 'text-danger' : score < 0 ? 'text-dark' : 'text-muted');
        } else {
            scoreElement.className = 'fs-1 fw-bold ' + 
                (score > 0 ? 'text-success' : score < 0 ? 'text-danger' : 'text-warning');
        }
        
        scoreElement.textContent = scoreValue;
        commentElement.textContent = comment || '--';
    }

    // æ‡‰ç”¨è©•åˆ†åˆ°ç³»çµ±
    document.getElementById('applyNewsScore').addEventListener('click', function() {
        const scoreText = document.getElementById('newsScoreDisplay').textContent;
        const score = parseInt(scoreText.replace('+', ''));
        if (!isNaN(score)) {
            applyAiScoreToSystem(score, 'news');
        } else {
            showToast('ç„¡æ³•è®€å–æ¶ˆæ¯é¢è©•åˆ†', 'error');
        }
    });
    
    document.getElementById('applyRiskScore').addEventListener('click', function() {
        const scoreText = document.getElementById('riskScoreDisplay').textContent;
        const score = parseInt(scoreText.replace('+', ''));
        if (!isNaN(score)) {
            applyAiScoreToSystem(score, 'risk');
        } else {
            showToast('ç„¡æ³•è®€å–é¢¨éšªé¢è©•åˆ†', 'error');
        }
    });
    
    document.getElementById('applyBothScores').addEventListener('click', function() {
        const newsScoreText = document.getElementById('newsScoreDisplay').textContent;
        const riskScoreText = document.getElementById('riskScoreDisplay').textContent;
        
        const newsScore = parseInt(newsScoreText.replace('+', ''));
        const riskScore = parseInt(riskScoreText.replace('+', ''));
        
        let appliedCount = 0;
        
        if (!isNaN(newsScore)) {
            applyAiScoreToSystem(newsScore, 'news');
            appliedCount++;
        }
        
        if (!isNaN(riskScore)) {
            applyAiScoreToSystem(riskScore, 'risk');
            appliedCount++;
        }
        
        if (appliedCount > 0) {
            showToast(`å·²æˆåŠŸæ‡‰ç”¨ ${appliedCount} é …è©•åˆ†ï¼`, 'success');
        } else {
            showToast('ç„¡æ³•è®€å–è©•åˆ†æ•¸æ“š', 'error');
        }
    });
    
    // æ‡‰ç”¨ AI è©•åˆ†åˆ°è©•åˆ†ç³»çµ±
    function applyAiScoreToSystem(score, analysisType) {
        const targetField = analysisType === 'news' ? 'news' : 'risk';
        const weight = weights[targetField] || 10;
        
        // è¨ˆç®—åŠ æ¬Šåˆ†æ•¸
        const weightedScore = Math.round((score / 10) * weight);
        
        // æ›´æ–°å°æ‡‰çš„è©•åˆ†é¡¯ç¤º
        const scoreElement = document.getElementById(`score_${targetField}`);
        if (scoreElement) {
            scoreElement.textContent = weightedScore;
            scoreElement.className = `badge ${weightedScore >= 0 ? 'badge-pos' : 'badge-neg'} fs-5`;
        }
        
        // æ›´æ–°èªªæ˜æ–‡å­—
        const descElement = scoreElement?.closest('tr')?.querySelector('td:nth-child(4)');
        if (descElement) {
            const typeName = analysisType === 'news' ? 'æ¶ˆæ¯é¢' : 'é¢¨éšªé¢';
            descElement.innerHTML = `<small>AI ${typeName}åˆ†æè©•åˆ†: ${score} â†’ åŠ æ¬Š: ${weightedScore}</small>`;
        }
        
        // æ›´æ–°ç¸½åˆ†
        updateTotalScore();
        
        log(`âœ… AI ${analysisType === 'news' ? 'æ¶ˆæ¯é¢' : 'é¢¨éšªé¢'}è©•åˆ† ${score} å·²æ‡‰ç”¨åˆ°ç³»çµ± (åŠ æ¬Š: ${weightedScore})`);
        showToast(`AI ${analysisType === 'news' ? 'æ¶ˆæ¯é¢' : 'é¢¨éšªé¢'}è©•åˆ†å·²æˆåŠŸæ‡‰ç”¨ï¼`, 'success');
    }

    // è¼”åŠ©å‡½æ•¸ï¼šè¤‡è£½åˆ°å‰ªè²¼ç°¿
    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        const text = element.textContent;
        navigator.clipboard.writeText(text).then(() => {
            showToast('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'success');
        }).catch(err => {
            console.error('è¤‡è£½å¤±æ•—: ', err);
            showToast('è¤‡è£½å¤±æ•—', 'error');
        });
    }

    // æ¸…é™¤åˆ†æçµæœ
    document.getElementById('clearAiAnalysis').addEventListener('click', function() {
        // æ¸…é™¤æ‰€æœ‰é¡¯ç¤ºå…§å®¹
        const aiAnalysisResult = document.getElementById('aiAnalysisResult');
        if (aiAnalysisResult) {
            aiAnalysisResult.style.display = 'none';
        }
        
        const elementsToClear = [
            { id: 'newsAnalysisContent', default: 'è«‹å…ˆé€²è¡Œåˆ†æ...' },
            { id: 'riskAnalysisContent', default: 'è«‹å…ˆé€²è¡Œåˆ†æ...' },
            { id: 'newsScoreDisplay', default: '--' },
            { id: 'riskScoreDisplay', default: '--' },
            { id: 'newsComment', default: '--' },
            { id: 'riskComment', default: '--' },
            { id: 'newsScoreBadge', default: '--/10' },
            { id: 'riskScoreBadge', default: '--/10' },
            { id: 'finalNewsScore', default: '--' },
            { id: 'finalRiskScore', default: '--' },
            { id: 'finalNewsComment', default: '--' },
            { id: 'finalRiskComment', default: '--' }
        ];
        
        elementsToClear.forEach(item => {
            const el = document.getElementById(item.id);
            if (el) el.textContent = item.default;
        });
        
        // æ¸…é™¤æ­·å²
        analysisHistory.news = null;
        analysisHistory.risk = null;
        
        // é‡ç½®é€²åº¦æ¢
        cleanupParallelAnalysis();
        
        log('å·²æ¸…é™¤æ‰€æœ‰åˆ†æçµæœ');
        showToast('å·²æ¸…é™¤æ‰€æœ‰åˆ†æçµæœ', 'info');
    });

    // ================= æ ¸å¿ƒ API å‡½æ•¸ =================

    async function fetchFinmind(dataset, dataId = '', startDate = '', endDate = '', retries = 3) {
        if (!TOKEN && dataset !== 'TaiwanStockInfo') return null;
        let url = `/.netlify/functions/fetch-finmind?dataset=${dataset}`;
        if (dataId) url += `&data_id=${dataId}`;
        if (startDate) url += `&start_date=${startDate}`;
        if (endDate) url += `&end_date=${endDate}`;
        if (TOKEN) url += `&token=${TOKEN}`;
        
        for (let attempt = 1; attempt <= retries; attempt++) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) {
                    if (attempt < retries) { 
                        await new Promise(r => setTimeout(r, 1000 * attempt)); 
                        continue; 
                    }
                    return null;
                }
                const data = await response.json();
                if (data.status === 200 && data.data) return data;
            } catch (err) { 
                if (attempt < retries) await new Promise(r => setTimeout(r, 1000 * attempt)); 
            }
        }
        return null;
    }

    async function fetchYahooWithProxy(symbol, logName) {
        log(`${logName} è«‹æ±‚ä¸­ (é€é Netlify Price Function ä»£ç†)...`);
        try {
            const response = await fetch(`/.netlify/functions/fetch-price?id=${symbol}`);
            if (!response.ok) {
                log(`${logName} ä»£ç†å¤±æ•—: ${response.status}`);
                return null;
            }
            const data = await response.json(); 
            if (data && data.chart?.result?.[0]) {
                log(`${logName} æˆåŠŸï¼`);
                return data;
            }
            log(`${logName} å¤±æ•—: æ ¼å¼éŒ¯èª¤`);
            return null;
        } catch (err) {
            log(`${logName} å¤±æ•—: ${err.message}`);
            return null;
        }
    }

    async function fetchTWSEPrice(stockId) {
        try {
            const response = await fetch(`https://openapi.twse.com.tw/v1/exchangeReport/STOCK_DAY?stockNo=${stockId}`);
            if (!response.ok) return null;
            const data = await response.json();
            return (data && Array.isArray(data) && data.length > 0) ? data : null;
        } catch (err) { return null; }
    }

    // ================= å¢å¼·ç‰ˆè²¡å‹™æ•¸æ“šç²å– =================
    
    async function fetchFinancialData(stockId) {
        log(`é–‹å§‹ç²å–è²¡å‹™æ•¸æ“š: ${stockId}`);
        
        // æ±ºå®šå…¬å¸é¡å‹
        let companyType;
        if (currentCompanyType === 'auto') {
            // è‡ªå‹•æª¢æ¸¬ï¼šä½¿ç”¨æª¢æ¸¬åˆ°çš„é¡å‹æˆ–é‡æ–°æª¢æ¸¬
            if (detectedCompanyType) {
                companyType = detectedCompanyType;
            } else {
                const detectionResult = await detectCompanyType(stockId);
                companyType = detectionResult ? detectionResult.type : 'listed'; // é»˜èªä¸Šå¸‚å…¬å¸
            }
        } else {
            companyType = currentCompanyType;
        }
        
        log(`ç¢ºå®šå…¬å¸é¡å‹: ${companyType}, è‚¡ç¥¨: ${stockId}`);
        
        // é‡ç½®è²¡å‹™å¿«å–
        financialCache = {
            eps: { quarters: {}, year: null },
            roe: { quarters: {}, year: null },
            revenueGrowth: { months: {}, quarters: {}, year: null },
            profitMargin: { quarters: {}, year: null },
            _metadata: { source: '', stock_id: stockId, last_updated: new Date().toISOString() }
        };
        
        let source = 'Unknown';
        let success = false;
        
        try {
            if (companyType === 'listed') {
                // 1. å„ªå…ˆå¾ FinMind ç²å–ä¸Šå¸‚å…¬å¸æ•¸æ“š
                if (TOKEN) {
                    log('å˜—è©¦å¾ FinMind ç²å–ä¸Šå¸‚å…¬å¸è²¡å‹™æ•¸æ“š...');
                    const finmindData = await fetchFinmindFinancials(stockId);
                    if (finmindData) {
                        source = 'FinMind (ä¸Šå¸‚å…¬å¸)';
                        log('âœ… FinMind ä¸Šå¸‚å…¬å¸è²¡å‹™æ•¸æ“šè¼‰å…¥æˆåŠŸ');
                        success = true;
                    }
                }
                
                // 2. å‚™æ´ï¼šè­‰äº¤æ‰€è²¡å ±
                if (!success) {
                    log('FinMind å¤±æ•—ï¼Œå˜—è©¦è­‰äº¤æ‰€è²¡å ±...');
                    const twseData = await fetchTWSEFinancials(stockId);
                    if (twseData) {
                        source = 'TWSE (ä¸Šå¸‚å…¬å¸)';
                        log('âœ… è­‰äº¤æ‰€è²¡å‹™æ•¸æ“šè¼‰å…¥æˆåŠŸ');
                        success = true;
                    }
                }
                
                // 3. æœ€çµ‚å‚™æ´ï¼šYahoo Finance
                if (!success) {
                    log('è­‰äº¤æ‰€å¤±æ•—ï¼Œå˜—è©¦ Yahoo Finance...');
                    const yahooData = await fetchYahooFinanceFinancials(stockId);
                    if (yahooData) {
                        source = 'Yahoo Finance (ä¸Šå¸‚å…¬å¸)';
                        log('âœ… Yahoo Finance è²¡å‹™æ•¸æ“šè¼‰å…¥æˆåŠŸ');
                        success = true;
                    }
                }
                
            } else if (companyType === 'otc' || companyType === 'emerging') {
                // ä¸Šæ«ƒ/èˆˆæ«ƒå…¬å¸ï¼šä½¿ç”¨ TPEx API
                log(`å˜—è©¦å¾ TPEx ç²å–${companyType === 'otc' ? 'ä¸Šæ«ƒ' : 'èˆˆæ«ƒ'}å…¬å¸è²¡å‹™æ•¸æ“š...`);
                const tpexData = await fetchTPExFinancials(stockId, companyType);
                if (tpexData) {
                    source = `TPEx (${companyType === 'otc' ? 'ä¸Šæ«ƒ' : 'èˆˆæ«ƒ'}å…¬å¸)`;
                    log(`âœ… TPEx ${companyType === 'otc' ? 'ä¸Šæ«ƒ' : 'èˆˆæ«ƒ'}å…¬å¸è²¡å‹™æ•¸æ“šè¼‰å…¥æˆåŠŸ`);
                    success = true;
                }
                
                // ä¸Šæ«ƒ/èˆˆæ«ƒå…¬å¸å‚™æ´ï¼šä½¿ç”¨ Yahoo Finance (.TWO)
                if (!success) {
                    log(`TPEx å¤±æ•—ï¼Œå˜—è©¦ Yahoo Finance (.TWO)...`);
                    const yahooData = await fetchYahooFinanceFinancials(`${stockId}.TWO`);
                    if (yahooData) {
                        source = `Yahoo Finance (${companyType === 'otc' ? 'ä¸Šæ«ƒ' : 'èˆˆæ«ƒ'}å…¬å¸)`;
                        log(`âœ… Yahoo Finance ${companyType === 'otc' ? 'ä¸Šæ«ƒ' : 'èˆˆæ«ƒ'}å…¬å¸è²¡å‹™æ•¸æ“šè¼‰å…¥æˆåŠŸ`);
                        success = true;
                    }
                }
            }
            
            if (!success) {
                log(`âŒ ${companyType === 'listed' ? 'ä¸Šå¸‚å…¬å¸' : companyType === 'otc' ? 'ä¸Šæ«ƒå…¬å¸' : 'èˆˆæ«ƒå…¬å¸'} æ‰€æœ‰è²¡å‹™æ•¸æ“šä¾†æºéƒ½å¤±æ•—`);
                // æä¾›é™ç´šæ•¸æ“š
                provideFallbackData(stockId, companyType);
                source = 'é™ç´šæ•¸æ“š (æ‰€æœ‰ä¾†æºå¤±æ•—)';
            }
            
            // æ›´æ–°å…ƒæ•¸æ“š
            financialCache._metadata.source = source;
            financialCache._metadata.company_type = companyType;
            
            return { 
                source, 
                data: financialCache, 
                companyType: companyType,
                success: success
            };
            
        } catch (error) {
            log(`âŒ ç²å–è²¡å‹™æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
            // æä¾›é™ç´šæ•¸æ“š
            provideFallbackData(stockId, companyType);
            return { 
                source: 'éŒ¯èª¤é™ç´šæ•¸æ“š', 
                data: financialCache, 
                companyType: companyType,
                success: false,
                error: error.message
            };
        }
    }

    // æä¾›é™ç´šæ•¸æ“š
    function provideFallbackData(stockId, companyType) {
        log(`æä¾›é™ç´šæ•¸æ“šçµ¦ ${stockId} (${companyType})`);
        
        // è¨­ç½®åŸºæœ¬çš„é™ç´šæ•¸æ“š
        financialCache = {
            eps: { 
                quarters: { 'Q1': 1.5, 'Q2': 1.8, 'Q3': 2.1, 'Q4': 2.5 }, 
                year: 8.0 
            },
            roe: { 
                quarters: { 'Q1': 8.5, 'Q2': 9.2, 'Q3': 10.1, 'Q4': 11.3 }, 
                year: 9.8 
            },
            revenueGrowth: { 
                months: {}, 
                quarters: { 'Q1': 12.5, 'Q2': 15.3, 'Q3': 18.7, 'Q4': 22.1 }, 
                year: 17.2 
            },
            profitMargin: { 
                quarters: { 'Q1': 25.3, 'Q2': 26.8, 'Q3': 28.1, 'Q4': 29.5 }, 
                year: 27.4 
            },
            _metadata: {
                source: 'fallback',
                stock_id: stockId,
                company_type: companyType,
                last_updated: new Date().toISOString(),
                note: 'æ‰€æœ‰æ•¸æ“šä¾†æºå¤±æ•—ï¼Œä½¿ç”¨é è¨­æ•¸æ“š'
            }
        };
    }

    // ä¸Šå¸‚å…¬å¸è²¡å‹™æ•¸æ“šç²å–ï¼ˆä¿æŒåŸæœ‰é‚è¼¯ï¼‰
    async function fetchFinmindFinancials(stockId) {
        try {
            log(`ğŸ” FinMind æ•¸æ“šç²å–é–‹å§‹: ${stockId}`);
            
            const [financialStatement, balanceSheet, revenueData] = await Promise.all([
                fetchFinmind('TaiwanStockFinancialStatements', stockId, '2020-01-01'),
                fetchFinmind('TaiwanStockBalanceSheet', stockId, '2020-01-01'),
                fetchFinmind('TaiwanStockMonthRevenue', stockId, '2020-01-01')
            ]);

            log(`ğŸ“Š FinMind æ•¸æ“šæª¢æŸ¥:`);
            log(`- è²¡å‹™å ±è¡¨ç­†æ•¸: ${financialStatement?.data?.length || 0}`);
            log(`- è³‡ç”¢è² å‚µè¡¨ç­†æ•¸: ${balanceSheet?.data?.length || 0}`);
            log(`- æœˆç‡Ÿæ”¶ç­†æ•¸: ${revenueData?.data?.length || 0}`);

            if (!financialStatement && !balanceSheet && !revenueData) {
                log('âŒ FinMind æ‰€æœ‰æ•¸æ“šé›†éƒ½ç‚ºç©º');
                return null;
            }

            // è™•ç†è²¡å‹™å ±è¡¨æ•¸æ“š
            if (financialStatement?.data) {
                log(`ğŸ”„ é‡çµ„è²¡å‹™å ±è¡¨æ•¸æ“š...`);
                
                const byDate = {};
                financialStatement.data.forEach(item => {
                    if (!byDate[item.date]) byDate[item.date] = {};
                    byDate[item.date][item.type] = item.value;
                    byDate[item.date]['_origin'] = byDate[item.date]['_origin'] || {};
                    byDate[item.date]['_origin'][item.type] = item.origin_name;
                });

                const byQuarter = {};
                let latestYearEPS = 0;
                let latestYearDate = '';
                
                const dates = Object.keys(byDate).sort().reverse();
                
                dates.forEach(date => {
                    const data = byDate[date];
                    const dateObj = new Date(date);
                    const year = dateObj.getFullYear();
                    const month = dateObj.getMonth() + 1;
                    const quarter = Math.floor((month + 2) / 3);
                    const quarterKey = `${year}Q${quarter}`;
                    
                    // è™•ç† EPS æ•¸æ“š
                    if (data.EPS !== undefined) {
                        const eps = parseFloat(data.EPS);
                        if (!isNaN(eps)) {
                            if (!byQuarter[quarterKey]) byQuarter[quarterKey] = {};
                            byQuarter[quarterKey].eps = eps;
                            byQuarter[quarterKey].date = date;
                            byQuarter[quarterKey].year = year;
                            byQuarter[quarterKey].quarter = quarter;
                            
                            if (year === 2025) {
                                latestYearEPS += eps;
                                latestYearDate = date;
                            }
                        }
                    }

                    // è¨ˆç®—æ¯›åˆ©ç‡
                    if (data.Revenue !== undefined && data.CostOfGoodsSold !== undefined) {
                        const revenue = parseFloat(data.Revenue);
                        const cost = parseFloat(data.CostOfGoodsSold);
                        
                        if (!isNaN(revenue) && !isNaN(cost) && revenue > 0) {
                            const grossProfit = revenue - cost;
                            const margin = (grossProfit / revenue) * 100;
                            
                            if (!byQuarter[quarterKey]) byQuarter[quarterKey] = {};
                            byQuarter[quarterKey].profitMargin = parseFloat(margin.toFixed(2));
                        }
                    }

                    // è¨ˆç®— ROE
                    if (data.IncomeAfterTaxes !== undefined || data.TotalConsolidatedProfitForThePeriod !== undefined) {
                        const netIncome = parseFloat(data.IncomeAfterTaxes || data.TotalConsolidatedProfitForThePeriod);
                        
                        if (balanceSheet?.data && !isNaN(netIncome)) {
                            const balanceItem = balanceSheet.data.find(b => b.date === date);
                            if (balanceItem) {
                                const equity = parseFloat(balanceItem.equity || balanceItem.total_equity || 
                                                       balanceItem['æ¬Šç›Šç¸½è¨ˆ'] || balanceItem['æ¬Šç›Šç¸½é¡'] ||
                                                       balanceItem['æ­¸å±¬æ–¼æ¯å…¬å¸æ¥­ä¸»ä¹‹æ¬Šç›Šåˆè¨ˆ']);
                                
                                if (!isNaN(equity) && equity > 0) {
                                    const roe = (netIncome / equity) * 100;
                                    
                                    if (!byQuarter[quarterKey]) byQuarter[quarterKey] = {};
                                    byQuarter[quarterKey].roe = parseFloat(roe.toFixed(2));
                                    
                                    if (year === 2025 && (!financialCache.roe.year || dateObj > new Date(financialCache.roe._latestDate || 0))) {
                                        financialCache.roe.year = parseFloat(roe.toFixed(2));
                                        financialCache.roe._latestDate = date;
                                    }
                                }
                            }
                        }
                    }
                });

                // è¨­ç½®å¹´åº¦ EPS
                if (latestYearEPS > 0) {
                    financialCache.eps.year = parseFloat(latestYearEPS.toFixed(2));
                }

                // æŒ‰å­£åº¦çµ„ç¹”æ•¸æ“š
                const quarterKeys = Object.keys(byQuarter).sort().reverse();
                const recentQuarters = quarterKeys.slice(0, 4);
                const sortedQuarters = recentQuarters.sort((a, b) => {
                    const [yearA, quarterA] = a.split('Q');
                    const [yearB, quarterB] = b.split('Q');
                    if (yearA !== yearB) return yearB - yearA;
                    return quarterA - quarterB;
                });
                
                sortedQuarters.forEach(quarterKey => {
                    const data = byQuarter[quarterKey];
                    const quarterNum = quarterKey.split('Q')[1];
                    
                    if (data.eps !== undefined) {
                        financialCache.eps.quarters[`Q${quarterNum}`] = data.eps;
                    }
                    
                    if (data.profitMargin !== undefined) {
                        financialCache.profitMargin.quarters[`Q${quarterNum}`] = data.profitMargin;
                    }
                    
                    if (data.roe !== undefined) {
                        financialCache.roe.quarters[`Q${quarterNum}`] = data.roe;
                    }
                });

                // å¦‚æœæ²’æœ‰ ROE æ•¸æ“šï¼Œè¨­ç½®é è¨­å€¼
                if (Object.keys(financialCache.roe.quarters).length === 0) {
                    financialCache.roe.quarters = {
                        'Q1': 9.36,
                        'Q2': 9.36, 
                        'Q3': 9.36,
                        'Q4': 9.36
                    };
                    financialCache.roe.year = 26.07;
                }
            }

            // è™•ç†ç‡Ÿæ”¶æˆé•·ç‡
            if (revenueData?.data) {
                log(`ğŸ”„ è™•ç†ç‡Ÿæ”¶æˆé•·ç‡æ•¸æ“š...`);
                const sortedRevenue = revenueData.data.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (sortedRevenue.length >= 2) {
                    log(`ğŸ“ˆ è¨ˆç®—æœˆåº¦ç‡Ÿæ”¶æˆé•·ç‡...`);
                    
                    for (let i = 0; i < sortedRevenue.length - 1; i++) {
                        const currentMonth = sortedRevenue[i];
                        const previousMonth = sortedRevenue[i + 1];
                        
                        const currentRevenue = parseFloat(currentMonth.revenue);
                        const previousRevenue = parseFloat(previousMonth.revenue);
                        
                        if (!isNaN(currentRevenue) && !isNaN(previousRevenue) && previousRevenue > 0) {
                            const date = new Date(currentMonth.date);
                            const year = date.getFullYear();
                            const month = date.getMonth() + 1;
                            const rocYear = (year - 1911).toString();
                            const monthKey = `${rocYear}${month.toString().padStart(2, '0')}`;
                            const monthGrowth = ((currentRevenue - previousRevenue) / previousRevenue) * 100;
                            
                            financialCache.revenueGrowth.months[monthKey] = parseFloat(monthGrowth.toFixed(2));
                            
                            if (Object.keys(financialCache.revenueGrowth.months).length >= 12) break;
                        }
                    }
                }

                // è¨ˆç®—å­£åº¦ç‡Ÿæ”¶æˆé•·ç‡
                const quarters = {};
                sortedRevenue.forEach(item => {
                    const date = new Date(item.date);
                    const year = date.getFullYear();
                    const quarter = Math.floor((date.getMonth() + 2) / 3);
                    const key = `${year}Q${quarter}`;
                    
                    if (!quarters[key]) quarters[key] = 0;
                    quarters[key] += parseFloat(item.revenue) || 0;
                });

                const quarterKeys = Object.keys(quarters).sort().slice(-8);
                for (let i = 4; i < quarterKeys.length; i++) {
                    const current = quarters[quarterKeys[i]];
                    const previous = quarters[quarterKeys[i - 4]];
                    
                    if (previous > 0) {
                        const growth = ((current - previous) / previous) * 100;
                        const quarterLabel = quarterKeys[i].slice(-2);
                        financialCache.revenueGrowth.quarters[quarterLabel] = parseFloat(growth.toFixed(2));
                    }
                }

                // å¹´åº¦ç‡Ÿæ”¶æˆé•·ç‡
                if (sortedRevenue.length >= 24) {
                    const currentYearTotal = sortedRevenue.slice(0, 12).reduce((sum, item) => sum + (parseFloat(item.revenue) || 0), 0);
                    const lastYearTotal = sortedRevenue.slice(12, 24).reduce((sum, item) => sum + (parseFloat(item.revenue) || 0), 0);
                    
                    if (lastYearTotal > 0) {
                        const growth = ((currentYearTotal - lastYearTotal) / lastYearTotal) * 100;
                        financialCache.revenueGrowth.year = parseFloat(growth.toFixed(2));
                    }
                }
            }

            return financialCache;

        } catch (err) {
            log(`âŒ FinMind è²¡å‹™æ•¸æ“šç²å–å¤±æ•—: ${err.message}`);
            console.error(err);
            return null;
        }
    }

    // ä¸Šæ«ƒ/èˆˆæ«ƒå…¬å¸è²¡å‹™æ•¸æ“šç²å–
    async function fetchTPExFinancials(stockId, companyType = 'emerging') {
        try {
            log(`ğŸ” TPEx ${companyType === 'otc' ? 'ä¸Šæ«ƒ' : 'èˆˆæ«ƒ'}å…¬å¸æ•¸æ“šç²å–é–‹å§‹: ${stockId}`);
            
            const response = await fetch(`/.netlify/functions/fetch-tpex?stock_id=${stockId}&data_type=financials&company_type=${companyType}`);
            
            if (!response.ok) {
                log(`TPEx API éŒ¯èª¤: ${response.status}`);
                return null;
            }
            
            const result = await response.json();
            
            if (result.error) {
                log(`TPEx æ•¸æ“šéŒ¯èª¤: ${result.error}`);
                return null;
            }
            
            if (result.success && result.data) {
                log(`âœ… TPEx æ•¸æ“šè§£ææˆåŠŸ`);
                
                // ä½¿ç”¨TPExè¿”å›çš„çµ±ä¸€æ ¼å¼æ•¸æ“š
                financialCache = result.data;
                
                // æ·»åŠ å…ƒæ•¸æ“š
                financialCache._metadata = financialCache._metadata || {};
                financialCache._metadata.source = 'TPEx';
                financialCache._metadata.stock_id = stockId;
                financialCache._metadata.company_type = companyType;
                financialCache._metadata.last_updated = new Date().toISOString();
                
                return financialCache;
            } else {
                log(`âŒ TPEx è¿”å›æ•¸æ“šæ ¼å¼éŒ¯èª¤`);
                return null;
            }
            
        } catch (err) {
            log(`âŒ TPEx è²¡å‹™æ•¸æ“šç²å–å¤±æ•—: ${err.message}`);
            console.error(err);
            return null;
        }
    }

    async function fetchTWSEFinancials(stockId) {
        log(`è­‰äº¤æ‰€è²¡å ± è«‹æ±‚ä¸­... (${stockId})`);
        
        try {
            const response = await fetch(`/.netlify/functions/fetch-twse?type=financials&stock_id=${stockId}`);
            
            if (!response.ok) {
                log(`è­‰äº¤æ‰€ä»£ç†è«‹æ±‚å¤±æ•—: ${response.status}`);
                return null;
            }
            
            const structuredData = await response.json();
            
            if (structuredData.error) {
                log(`è­‰äº¤æ‰€æ•¸æ“šéŒ¯èª¤: ${structuredData.error}`);
                return null;
            }
            
            financialCache = structuredData;
            
            // æ·»åŠ å…ƒæ•¸æ“š
            financialCache._metadata = financialCache._metadata || {};
            financialCache._metadata.source = 'TWSE';
            financialCache._metadata.stock_id = stockId;
            financialCache._metadata.company_type = 'listed';
            financialCache._metadata.last_updated = new Date().toISOString();
            
            log(`âœ… TWSE çµæ§‹åŒ–æ•¸æ“šè¼‰å…¥æˆåŠŸ`);
            return financialCache;
            
        } catch (err) {
            log(`è­‰äº¤æ‰€æ•¸æ“šè™•ç†å¤±æ•—: ${err.message}`);
            return null;
        }
    }

    async function fetchYahooFinanceFinancials(stockId) {
        try {
            const response = await fetch(`/.netlify/functions/fetch-financials?id=${stockId}`);
            if (!response.ok) return null;
            const result = await response.json(); 
            if (result && !result.error) {
                financialCache.eps.year = result.defaultKeyStatistics?.trailingEps?.raw || 'N/A';
                financialCache.roe.year = result.financialData?.returnOnEquity?.raw ? result.financialData.returnOnEquity.raw * 100 : 'N/A';
                if (financialCache.revenueGrowth.year === 'N/A') {
                    financialCache.revenueGrowth.year = result.financialData?.revenueGrowth?.raw ? (result.financialData.revenueGrowth.raw * 100).toFixed(2) : 'N/A';
                }
                financialCache.profitMargin.quarters['Q1'] = result.financialData?.grossMargins?.raw ? result.financialData.grossMargins.raw * 100 : 'N/A';
                
                // æ·»åŠ å…ƒæ•¸æ“š
                financialCache._metadata = financialCache._metadata || {};
                financialCache._metadata.source = 'Yahoo Finance';
                financialCache._metadata.stock_id = stockId;
                financialCache._metadata.last_updated = new Date().toISOString();
                
                return financialCache;
            }
            return null;
        } catch (err) { return null; }
    }

    // ================= è³‡æ–™è¼‰å…¥é‚è¼¯ =================

    async function loadStockData() {
        // é¡¯ç¤ºåŠ è¼‰ç‹€æ…‹
        const loadingElement = document.getElementById('stockSelectLoading');
        if (loadingElement) {
            loadingElement.style.display = 'block';
        }
        
        let isLoaded = false;
        
        // åªåŠ è¼‰ä¸Šå¸‚å…¬å¸æ•¸æ“šï¼ˆä¸Šæ«ƒ/èˆˆæ«ƒå…¬å¸æ•¸æ“šé€šéAPIç²å–ï¼‰
        if (TOKEN) {
            try {
                const finInfo = await fetchFinmind('TaiwanStockInfo');
                if (finInfo?.data && finInfo.data.length > 0) {
                    stockData.listed = finInfo.data;
                    isLoaded = true;
                    log(`FinMind æˆåŠŸè¼‰å…¥ ${stockData.listed.length} ç­†ä¸Šå¸‚å…¬å¸è³‡æ–™`);
                }
            } catch (err) { 
                console.error('FinMindè¼‰å…¥éŒ¯èª¤:', err);
                log(`FinMindè¼‰å…¥éŒ¯èª¤: ${err.message}`);
            }
        }

        if (!isLoaded) {
            log('åˆ‡æ›è‡³ TWSE è­‰äº¤æ‰€ä¾†æºç²å–ä¸Šå¸‚å…¬å¸æ¸…å–®...');
            try {
                const response = await fetch('/.netlify/functions/fetch-twse?type=stocks');
                if (response.ok) {
                    const twseData = await response.json();
                    stockData.listed = twseData.map(item => {
                        let category = item['ç”¢æ¥­åˆ¥'] || 'å…¶ä»–';
                        if (twseIndustryMap[category]) category = twseIndustryMap[category];
                        return {
                            stock_id: item['å…¬å¸ä»£è™Ÿ'] || item.Code,
                            stock_name: item['å…¬å¸åç¨±'] || item['å…¬å¸ç°¡ç¨±'] || item.Name,
                            industry_category: category
                        };
                    }).filter(s => s.stock_id && s.stock_name);
                    
                    const uniqueStocks = new Map();
                    stockData.listed.forEach(s => uniqueStocks.set(s.stock_id, s));
                    stockData.listed = Array.from(uniqueStocks.values());

                    if (stockData.listed.length > 0) {
                        isLoaded = true;
                        log(`TWSE å‚™æ´æˆåŠŸè¼‰å…¥ ${stockData.listed.length} ç­†ä¸Šå¸‚å…¬å¸è³‡æ–™`);
                    }
                }
            } catch (err) { 
                log(`TWSE å‚™æ´è¼‰å…¥å¤±æ•—: ${err.message}`);
            }
        }

        // éš±è—åŠ è¼‰ç‹€æ…‹
        if (loadingElement) {
            loadingElement.style.display = 'none';
        }

        if (isLoaded) {
            industryCategories = new Set(stockData.listed.map(stock => stock.industry_category).filter(Boolean));
            updateCategorySelect();
            log('ä¸Šå¸‚å…¬å¸è³‡æ–™è¼‰å…¥å®Œæˆ');
        } else {
            log('âŒ ç„¡æ³•è¼‰å…¥ä¸Šå¸‚å…¬å¸æ¸…å–®ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
            showToast('ç„¡æ³•è¼‰å…¥ä¸Šå¸‚å…¬å¸æ¸…å–®ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', 'error');
        }
    }
    
    // æ›´æ–°é¡è‚¡é¸æ“‡ä¸‹æ‹‰é¸å–®
    function updateCategorySelect() {
        const categorySelect = document.getElementById('stockCategory');
        if (!categorySelect) return;
        
        categorySelect.innerHTML = '<option value="all">å…¨éƒ¨é¡è‚¡</option>';
        
        // ç¢ºä¿ industryCategories å·²å®šç¾©
        if (typeof industryCategories !== 'undefined' && industryCategories.size > 0) {
            industryCategories.forEach(category => {
                if (category) {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                }
            });
        } else {
            // å¦‚æœé‚„æ²’æœ‰é¡åˆ¥æ•¸æ“šï¼Œæ·»åŠ é»˜èªé¸é …
            const defaultCategories = [
                'æ°´æ³¥å·¥æ¥­', 'é£Ÿå“å·¥æ¥­', 'å¡‘è† å·¥æ¥­', 'ç´¡ç¹”çº–ç¶­', 'é›»å­å·¥æ¥­',
                'é›»æ©Ÿæ©Ÿæ¢°', 'å»ºæç‡Ÿé€ ', 'èˆªé‹æ¥­', 'é‡‘èä¿éšª', 'å…¶ä»–'
            ];
            
            defaultCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        }
    }
    
    // æ›´æ–°ä¸»è‚¡ç¥¨é¸æ“‡æ¸…å–®
    function updateStockSelect() {
        const stockSelect = document.getElementById('stockSelect');
        if (!stockSelect) return;
        
        stockSelect.innerHTML = '<option value="">è«‹é¸æ“‡æˆ–æœå°‹è‚¡ç¥¨</option>';
        
        // å¦‚æœé‚„æ²’æœ‰è‚¡ç¥¨æ•¸æ“šï¼Œé¡¯ç¤ºæç¤º
        if (stockData.listed.length === 0) {
            stockSelect.innerHTML = '<option value="">è¼‰å…¥è‚¡ç¥¨è³‡æ–™ä¸­...</option>';
            stockSelect.disabled = true;
            return;
        }
        
        stockSelect.disabled = false;
        
        // é¡¯ç¤ºæ‰€æœ‰è‚¡ç¥¨ï¼ˆä¸åˆ†é¡è‚¡ï¼‰
        let filteredStocks = stockData.listed;
        filteredStocks.sort((a, b) => a.stock_id.localeCompare(b.stock_id));
        filteredStocks.forEach(stock => {
            const option = document.createElement('option');
            option.value = stock.stock_id;
            option.textContent = `${stock.stock_id} ${stock.stock_name}`;
            stockSelect.appendChild(option);
        });
        
        if (filteredStocks.length === 0) {
            stockSelect.innerHTML = '<option value="">ç„¡è‚¡ç¥¨è³‡æ–™</option>';
        }
    }
    
    // æ›´æ–°ä¸Šå¸‚å…¬å¸é¸æ“‡æ¸…å–®ï¼ˆæ ¹æ“šé¡è‚¡ç¯©é¸ï¼‰
    function updateListedStockSelect() {
        const listedStockSelect = document.getElementById('listedStockSelect');
        if (!listedStockSelect) return;
        
        listedStockSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡é¡è‚¡</option>';
        
        // å¦‚æœå…¬å¸é¡å‹ä¸æ˜¯ä¸Šå¸‚å…¬å¸ï¼Œç¦ç”¨ä¸¦é¡¯ç¤ºæç¤º
        if (currentCompanyType !== 'listed' && currentCompanyType !== 'auto') {
            listedStockSelect.disabled = true;
            listedStockSelect.innerHTML = '<option value="">åƒ…ä¸Šå¸‚å…¬å¸å¯ç”¨</option>';
            return;
        }
        
        listedStockSelect.disabled = false;
        
        // ç²å–é¸ä¸­çš„é¡è‚¡
        const category = document.getElementById('stockCategory')?.value || 'all';
        
        // å¦‚æœé‚„æ²’æœ‰è‚¡ç¥¨æ•¸æ“šï¼Œé¡¯ç¤ºæç¤º
        if (stockData.listed.length === 0) {
            listedStockSelect.innerHTML = '<option value="">è¼‰å…¥è‚¡ç¥¨è³‡æ–™ä¸­...</option>';
            return;
        }
        
        let filteredStocks = stockData.listed;
        if (category !== 'all') {
            filteredStocks = stockData.listed.filter(stock => stock.industry_category === category);
        }
        
        filteredStocks.sort((a, b) => a.stock_id.localeCompare(b.stock_id));
        filteredStocks.forEach(stock => {
            const option = document.createElement('option');
            option.value = stock.stock_id;
            option.textContent = `${stock.stock_id} ${stock.stock_name}`;
            listedStockSelect.appendChild(option);
        });
        
        if (filteredStocks.length === 0) {
            listedStockSelect.innerHTML = '<option value="">è©²é¡è‚¡ç„¡è‚¡ç¥¨è³‡æ–™</option>';
        }
    }

    // ================= æ¨¡ç³ŠæŸ¥è©¢åŠŸèƒ½ =================
    
    // é¡¯ç¤ºæœç´¢å»ºè­°
    function showSearchSuggestions(searchTerm) {
        const suggestionsContainer = document.getElementById('searchSuggestions');
        if (!suggestionsContainer) return;
        
        // æ¸…ç©ºä¹‹å‰çš„å»ºè­°
        suggestionsContainer.innerHTML = '';
        
        if (!searchTerm || searchTerm.trim() === '') {
            suggestionsContainer.style.display = 'none';
            return;
        }
        
        const term = searchTerm.trim().toLowerCase();
        
        // å¾è‚¡ç¥¨æ•¸æ“šä¸­æœç´¢
        let suggestions = [];
        
        // æœç´¢ä¸Šå¸‚å…¬å¸
        if (stockData.listed && stockData.listed.length > 0) {
            stockData.listed.forEach(stock => {
                const stockCode = stock.stock_id || '';
                const stockName = stock.stock_name || '';
                
                if (stockCode.includes(term) || stockName.toLowerCase().includes(term)) {
                    suggestions.push({
                        code: stockCode,
                        name: stockName,
                        type: 'listed',
                        typeText: 'ä¸Šå¸‚å…¬å¸'
                    });
                }
            });
        }
        
        // é™åˆ¶é¡¯ç¤ºæ•¸é‡
        suggestions = suggestions.slice(0, 10);
        
        if (suggestions.length === 0) {
            suggestionsContainer.style.display = 'none';
            return;
        }
        
        // é¡¯ç¤ºå»ºè­°
        suggestions.forEach(suggestion => {
            const item = document.createElement('div');
            item.className = 'search-suggestion-item';
            item.innerHTML = `
                <div>
                    <span class="stock-code">${suggestion.code}</span>
                    <span class="stock-name">${suggestion.name}</span>
                    <span class="stock-type ${suggestion.type === 'listed' ? 'type-listed' : suggestion.type === 'otc' ? 'type-otc' : 'type-emerging'}">
                        ${suggestion.typeText}
                    </span>
                </div>
            `;
            
            item.addEventListener('click', () => {
                const searchInput = document.getElementById('searchStockInput');
                if (searchInput) {
                    searchInput.value = suggestion.code;
                }
                suggestionsContainer.style.display = 'none';
                
                // è‡ªå‹•è§¸ç™¼æœç´¢
                setTimeout(() => {
                    document.getElementById('confirmSearchBtn').click();
                }, 100);
            });
            
            suggestionsContainer.appendChild(item);
        });
        
        suggestionsContainer.style.display = 'block';
    }
    
    // é»æ“Šå¤–éƒ¨éš±è—å»ºè­°
    document.addEventListener('click', function(event) {
        const suggestionsContainer = document.getElementById('searchSuggestions');
        const searchInput = document.getElementById('searchStockInput');
        
        if (suggestionsContainer && searchInput && 
            !suggestionsContainer.contains(event.target) && 
            !searchInput.contains(event.target)) {
            suggestionsContainer.style.display = 'none';
        }
    });

    // æœç´¢è¼¸å…¥æ¡†äº‹ä»¶ç›£è½
    document.getElementById('searchStockInput')?.addEventListener('input', function() {
        const searchTerm = this.value;
        showSearchSuggestions(searchTerm);
    });

    // ================= æ–°å¢æŒ‰éˆ•äº‹ä»¶è™•ç† =================
    
    // ç¢ºèªé¸æ“‡æŒ‰éˆ•ï¼ˆä¸»è‚¡ç¥¨é¸æ“‡ï¼‰
    document.getElementById('confirmSelectionBtn').addEventListener('click', async function() {
        const stockSelect = document.getElementById('stockSelect');
        if (!stockSelect || !stockSelect.value) {
            showToast('è«‹å…ˆé¸æ“‡è‚¡ç¥¨', 'error');
            return;
        }
        
        const symbol = stockSelect.value.trim();
        const selectedOption = stockSelect.options[stockSelect.selectedIndex];
        let stockName = '';
        
        if (selectedOption && selectedOption.textContent) {
            const text = selectedOption.textContent.trim();
            const match = text.match(/^\d+\s+(.+)$/);
            stockName = match ? match[1] : text;
        }
        
        log(`ç¢ºèªé¸æ“‡è‚¡ç¥¨: ${symbol} ${stockName}`);
        
        // æª¢æ¸¬å…¬å¸é¡å‹
        const detectionResult = await detectCompanyType(symbol);
        
        if (detectionResult && detectionResult.type !== 'not_found' && detectionResult.type !== 'unknown') {
            showToast(`å·²é¸æ“‡: ${detectionResult.stock_name || stockName}`, 'success');
            
            // ä¿å­˜åˆ°æœå°‹æ­·å²
            saveSearchHistory(symbol, detectionResult.stock_name || stockName, detectionResult.type);
            
            // æ›´æ–°æœç´¢æ¡†çš„å€¼
            const searchInput = document.getElementById('searchStockInput');
            if (searchInput) {
                searchInput.value = symbol;
            }
        } else {
            showToast(`ç„¡æ³•è­˜åˆ¥å…¬å¸é¡å‹: ${symbol}`, 'warning');
        }
    });
    
    // ç¢ºèªä¸Šå¸‚å…¬å¸é¸æ“‡æŒ‰éˆ•
    document.getElementById('confirmListedSelectionBtn').addEventListener('click', async function() {
        const listedStockSelect = document.getElementById('listedStockSelect');
        if (!listedStockSelect || !listedStockSelect.value) {
            showToast('è«‹å…ˆé¸æ“‡è‚¡ç¥¨', 'error');
            return;
        }
        
        const symbol = listedStockSelect.value.trim();
        const selectedOption = listedStockSelect.options[listedStockSelect.selectedIndex];
        let stockName = '';
        
        if (selectedOption && selectedOption.textContent) {
            const text = selectedOption.textContent.trim();
            const match = text.match(/^\d+\s+(.+)$/);
            stockName = match ? match[1] : text;
        }
        
        log(`ç¢ºèªé¸æ“‡ä¸Šå¸‚å…¬å¸: ${symbol} ${stockName}`);
        
        // æª¢æ¸¬å…¬å¸é¡å‹
        const detectionResult = await detectCompanyType(symbol);
        
        if (detectionResult && detectionResult.type !== 'not_found' && detectionResult.type !== 'unknown') {
            showToast(`å·²é¸æ“‡: ${detectionResult.stock_name || stockName}`, 'success');
            
            // ä¿å­˜åˆ°æœå°‹æ­·å²
            saveSearchHistory(symbol, detectionResult.stock_name || stockName, detectionResult.type);
            
            // æ›´æ–°æœç´¢æ¡†çš„å€¼
            const searchInput = document.getElementById('searchStockInput');
            if (searchInput) {
                searchInput.value = symbol;
            }
            
            // æ›´æ–°ä¸»è‚¡ç¥¨é¸æ“‡
            const stockSelect = document.getElementById('stockSelect');
            if (stockSelect) {
                stockSelect.value = symbol;
            }
        } else {
            showToast(`ç„¡æ³•è­˜åˆ¥å…¬å¸é¡å‹: ${symbol}`, 'warning');
        }
    });

    // æœç´¢ç¢ºèªæŒ‰éˆ•åŠŸèƒ½ï¼ˆå·²å¢å¼·ï¼‰
    document.getElementById('confirmSearchBtn').addEventListener('click', async function() {
        const searchInput = document.getElementById('searchStockInput');
        if (!searchInput || !searchInput.value.trim()) {
            showToast('è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±', 'error');
            return;
        }
        
        const searchTerm = searchInput.value.trim();
        log(`æœç´¢ç¢ºèªæŒ‰éˆ•é»æ“Š: ${searchTerm}`);
        
        // é¦–å…ˆå˜—è©¦åœ¨ç¾æœ‰æ¸…å–®ä¸­åŒ¹é…
        const stockSelect = document.getElementById('stockSelect');
        
        // é€²è¡Œæ¨¡ç³ŠæŸ¥è©¢
        const searchResults = performFuzzySearch(searchTerm);
        
        if (searchResults.length > 0) {
            log(`æ‰¾åˆ° ${searchResults.length} å€‹åŒ¹é…çµæœ`);
            
            // æ›´æ–°è‚¡ç¥¨é¸æ“‡ä¸‹æ‹‰é¸å–®
            stockSelect.innerHTML = '<option value="">è«‹é¸æ“‡è‚¡ç¥¨</option>';
            
            searchResults.forEach(result => {
                const option = document.createElement('option');
                option.value = result.code;
                option.textContent = `${result.code} ${result.name} (${result.type === 'listed' ? 'ä¸Šå¸‚' : result.type === 'otc' ? 'ä¸Šæ«ƒ' : 'èˆˆæ«ƒ'})`;
                option.dataset.type = result.type;
                stockSelect.appendChild(option);
            });
            
            // è‡ªå‹•é¸æ“‡ç¬¬ä¸€å€‹çµæœ
            if (searchResults.length === 1) {
                stockSelect.value = searchResults[0].code;
                showToast(`å·²æ‰¾åˆ°: ${searchResults[0].name}`, 'success');
                
                // è‡ªå‹•é»æ“Šç¢ºèªé¸æ“‡æŒ‰éˆ•
                setTimeout(() => {
                    document.getElementById('confirmSelectionBtn').click();
                }, 500);
            } else {
                showToast(`æ‰¾åˆ° ${searchResults.length} å€‹åŒ¹é…çµæœï¼Œè«‹é¸æ“‡ä¸€å€‹`, 'info');
            }
            
        } else {
            log(`åœ¨æ¸…å–®ä¸­æœªæ‰¾åˆ°åŒ¹é…ï¼Œé–‹å§‹å…¬å¸é¡å‹æª¢æ¸¬: ${searchTerm}`);
            const detectionResult = await detectCompanyType(searchTerm);
            
            if (detectionResult && detectionResult.type !== 'not_found' && detectionResult.type !== 'unknown') {
                const typeName = detectionResult.type === 'listed' ? 'ä¸Šå¸‚' : detectionResult.type === 'otc' ? 'ä¸Šæ«ƒ' : 'èˆˆæ«ƒ';
                const displayName = detectionResult.stock_name || searchTerm;
                
                log(`æ‰¾åˆ°${typeName}å…¬å¸: ${displayName}`);
                showToast(`æ‰¾åˆ°${typeName}å…¬å¸: ${displayName}`, 'success');
                
                // ä¿å­˜åˆ°æœå°‹æ­·å²
                saveSearchHistory(searchTerm, displayName, detectionResult.type);
                
                // å˜—è©¦åœ¨ä¸»è‚¡ç¥¨é¸æ“‡ä¸­æ‰¾åˆ°æˆ–æ·»åŠ é¸é …
                if (stockSelect) {
                    // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰é€™å€‹é¸é …
                    let existingOption = null;
                    for (let i = 0; i < stockSelect.options.length; i++) {
                        if (stockSelect.options[i].value === searchTerm) {
                            existingOption = stockSelect.options[i];
                            break;
                        }
                    }
                    
                    if (!existingOption) {
                        // å‰µå»ºæ–°é¸é …
                        const option = document.createElement('option');
                        option.value = searchTerm;
                        option.textContent = `${searchTerm} ${displayName}`;
                        option.dataset.type = detectionResult.type;
                        stockSelect.appendChild(option);
                    }
                    
                    // é¸ä¸­é€™å€‹é¸é …
                    stockSelect.value = searchTerm;
                    
                    // è‡ªå‹•é»æ“Šç¢ºèªé¸æ“‡æŒ‰éˆ•
                    setTimeout(() => {
                        document.getElementById('confirmSelectionBtn').click();
                    }, 500);
                }
                
            } else {
                log(`æœªæ‰¾åˆ°å…¬å¸: ${searchTerm}`);
                showToast(`æœªæ‰¾åˆ°å…¬å¸: ${searchTerm}`, 'warning');
            }
        }
    });
    
    // åŸ·è¡Œæ¨¡ç³ŠæŸ¥è©¢
    function performFuzzySearch(searchTerm) {
        if (!searchTerm || searchTerm.trim() === '') {
            return [];
        }
        
        const term = searchTerm.trim().toLowerCase();
        const results = [];
        
        // æœç´¢ä¸Šå¸‚å…¬å¸
        if (stockData.listed && stockData.listed.length > 0) {
            stockData.listed.forEach(stock => {
                const stockCode = stock.stock_id || '';
                const stockName = stock.stock_name || '';
                
                // ç²¾ç¢ºåŒ¹é…ä»£ç¢¼
                if (stockCode === term) {
                    results.unshift({
                        code: stockCode,
                        name: stockName,
                        type: 'listed',
                        score: 100
                    });
                }
                // éƒ¨åˆ†åŒ¹é…ä»£ç¢¼
                else if (stockCode.includes(term)) {
                    results.push({
                        code: stockCode,
                        name: stockName,
                        type: 'listed',
                        score: 80
                    });
                }
                // æ¨¡ç³ŠåŒ¹é…åç¨±
                else if (stockName.toLowerCase().includes(term)) {
                    results.push({
                        code: stockCode,
                        name: stockName,
                        type: 'listed',
                        score: 60
                    });
                }
            });
        }
        
        // æŒ‰åˆ†æ•¸æ’åº
        results.sort((a, b) => b.score - a.score);
        
        return results;
    }

    // å¿«é€Ÿæœå°‹é¸æ“‡è™•ç†
    document.getElementById('applyQuickSearch').addEventListener('click', async function() {
        const quickSearchSelect = document.getElementById('quickSearchSelect');
        if (!quickSearchSelect || !quickSearchSelect.value) {
            showToast('è«‹é¸æ“‡è‚¡ç¥¨', 'error');
            return;
        }
        
        const selectedValue = quickSearchSelect.value;
        const selectedOption = quickSearchSelect.options[quickSearchSelect.selectedIndex];
        const stockText = selectedOption.textContent;
        
        // å¾æ–‡æœ¬ä¸­æå–è‚¡ç¥¨ä»£ç¢¼å’Œåç¨±
        const match = stockText.match(/^(\d+)\s+(.+?)(?:\s+\([ä¸Šä¸­èˆˆ]å¸‚\))?$/);
        const stockCode = match ? match[1] : selectedValue;
        const stockName = match ? match[2] : selectedValue;
        
        log(`å¿«é€Ÿæœå°‹é¸æ“‡: ${stockCode} ${stockName}`);
        
        // æª¢æ¸¬å…¬å¸é¡å‹
        const detectionResult = await detectCompanyType(stockCode);
        
        // æ ¹æ“šæª¢æ¸¬çµæœæ›´æ–°UI
        if (detectionResult && detectionResult.type !== 'not_found') {
            // æ›´æ–°ä¸»æœç´¢æ¡†å’Œä¸‹æ‹‰é¸å–®
            const searchInput = document.getElementById('searchStockInput');
            const stockSelect = document.getElementById('stockSelect');
            
            if (searchInput) {
                searchInput.value = stockCode;
            }
            
            if (stockSelect) {
                // å˜—è©¦åœ¨æ¸…å–®ä¸­æ‰¾åˆ°å°æ‡‰çš„é¸é …
                for (let i = 0; i < stockSelect.options.length; i++) {
                    if (stockSelect.options[i].value === stockCode) {
                        stockSelect.selectedIndex = i;
                        break;
                    }
                }
            }
            
            // ä¿å­˜åˆ°æœå°‹æ­·å²
            saveSearchHistory(stockCode, detectionResult.stock_name || stockName, detectionResult.type);
            
            showToast(`å·²é¸æ“‡: ${detectionResult.stock_name || stockName}`, 'success');
            
            // è‡ªå‹•é»æ“Šç¢ºèªé¸æ“‡æŒ‰éˆ•
            setTimeout(() => {
                document.getElementById('confirmSelectionBtn').click();
            }, 500);
        } else {
            showToast(`ç„¡æ³•è­˜åˆ¥å…¬å¸é¡å‹: ${stockCode}`, 'warning');
        }
    });

    // ================= UI æ›´æ–°èˆ‡è©•åˆ†è¨ˆç®— =================

    function updateFinancialUI() {
        const getVal = (sel, key) => {
            const el = document.querySelector(`.period-select[data-type="${sel}"]`);
            if (!el) {
                console.warn(`æ‰¾ä¸åˆ°æœŸé–“é¸å–®: ${sel}`);
                return 'N/A';
            }
            
            const period = el.value;
            
            if (period === 'å¹´' || period === 'å¹´(ç´¯è¨ˆ)') {
                const val = financialCache[key]?.year;
                return (val === null || val === undefined || val === 'N/A') ? 'N/A' : val;
                
            } else if (period === 'å­£') {
                const quarters = financialCache[key]?.quarters || {};
                const quarterKeys = Object.keys(quarters).sort().reverse();
                
                if (quarterKeys.length === 0) return 'N/A';
                
                // EPS ç‰¹æ®Šè™•ç†ï¼šå–å‰ä¸€å­£æ•¸æ“šï¼ˆå› ç‚ºæœ¬å­£å¯èƒ½é‚„æœªçµæŸï¼‰
                let targetQuarter;
                if (sel === 'eps') {
                    // å–ç¬¬äºŒæ–°çš„å­£åº¦ï¼ˆå‰ä¸€å­£ï¼‰
                    targetQuarter = quarterKeys.length > 1 ? quarterKeys[1] : quarterKeys[0];
                    log(`EPS å­£åº¦ç‰¹æ®Šè™•ç†: ä½¿ç”¨ ${targetQuarter} è€Œé ${quarterKeys[0]}`);
                } else {
                    // å…¶ä»–æŒ‡æ¨™ä½¿ç”¨æœ€æ–°å­£åº¦
                    targetQuarter = quarterKeys[0];
                }
                
                const val = quarters[targetQuarter];
                log(`${sel} å­£åº¦æ•¸æ“š: ä½¿ç”¨ ${targetQuarter} = ${val}`);
                return (val === null || val === undefined) ? 'N/A' : val;
                
            } else if (period === 'æœˆ') {
                const months = financialCache[key]?.months || {};
                const monthKeys = Object.keys(months).sort().reverse();
                
                if (monthKeys.length === 0) return 'N/A';
                
                const latestMonth = monthKeys[0];
                const val = months[latestMonth];
                log(`${sel} æœˆåº¦æ•¸æ“š: ä½¿ç”¨ ${latestMonth} = ${val}`);
                return (val === null || val === undefined) ? 'N/A' : val;
            }
            
            return 'N/A';
        };

        const setUI = (id, val, suffix) => {
            const displayEl = document.getElementById(id);
            const inputEl = document.getElementById(id.replace('display', 'manual'));
            
            let displayVal;
            if (val === 'N/A') {
                displayVal = 'N/A';
            } else {
                const numVal = parseFloat(val);
                displayVal = isNaN(numVal) ? 'N/A' : `${numVal.toFixed(2)}${suffix}`;
            }
            
            if (displayEl) {
                displayEl.textContent = displayVal;
            }
            
            if (inputEl) {
                inputEl.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
                inputEl.placeholder = ''; // çµ±ä¸€çš„placeholder
            }
        };

        const eps = getVal('eps', 'eps');
        setUI('displayEps', eps, ' å…ƒ');

        const roe = getVal('roe', 'roe');
        setUI('displayRoe', roe, '%');

        const rev = getVal('revenue', 'revenueGrowth');
        setUI('displayRevenue', rev, '%');

        const margin = getVal('margin', 'profitMargin');
        setUI('displayMargin', margin, '%');

        calculateBasicScoreFromManualInput();
    }
    
    function setupPeriodChangeListeners() {
        document.querySelectorAll('.period-select').forEach(select => {
            select.addEventListener('change', () => {
                log(`æœŸé–“åˆ‡æ›: ${select.dataset.type} â†’ ${select.value}`);
                updateFinancialUI();
            });
        });
    }
    
    function setupManualInputListeners() {
        document.querySelectorAll('.manual-input').forEach(input => {
            input.addEventListener('input', () => {
                log(`æ‰‹å‹•è¼¸å…¥: ${input.id} = ${input.value}`);
                calculateBasicScoreFromManualInput();
            });
        });
    }

    window.calculateBasicScoreFromManualInput = function() {
        const getNum = (id, sel, key) => {
            const manualInput = document.getElementById(id);
            if (manualInput && manualInput.value !== '') {
                const manualVal = parseFloat(manualInput.value);
                if (!isNaN(manualVal)) {
                    log(`${id}: ä½¿ç”¨æ‰‹å‹•è¼¸å…¥å€¼ ${manualVal}`);
                    return manualVal;
                }
            }

            const el = document.querySelector(`.period-select[data-type="${sel}"]`);
            if (!el) return NaN;
            
            const period = el.value;
            let val;
            
            if (period === 'å¹´' || period === 'å¹´(ç´¯è¨ˆ)') {
                val = financialCache[key]?.year;
            } else if (period === 'å­£') {
                const quarters = financialCache[key]?.quarters || {};
                const quarterKeys = Object.keys(quarters).sort().reverse();
                
                // EPS ç‰¹æ®Šè™•ç†ï¼šå–å‰ä¸€å­£æ•¸æ“š
                let targetQuarter;
                if (sel === 'eps') {
                    targetQuarter = quarterKeys.length > 1 ? quarterKeys[1] : quarterKeys[0];
                } else {
                    targetQuarter = quarterKeys[0];
                }
                
                val = quarterKeys.length > 0 ? quarters[targetQuarter] : null;
            } else if (period === 'æœˆ') {
                const months = financialCache[key]?.months || {};
                const monthKeys = Object.keys(months).sort().reverse();
                val = monthKeys.length > 0 ? months[monthKeys[0]] : null;
            }
            
            if (val === null || val === undefined || val === 'N/A') return NaN;
            
            const numVal = parseFloat(val);
            log(`${id}: ä½¿ç”¨å¿«å–å€¼ ${numVal} (æœŸé–“: ${period})`);
            return numVal;
        };

        const epsInput = getNum('manualEps', 'eps', 'eps');
        const roeInput = getNum('manualRoe', 'roe', 'roe');
        const revenueGrowthInput = getNum('manualRevenueGrowth', 'revenue', 'revenueGrowth');
        const profitMarginInput = getNum('manualProfitMargin', 'margin', 'profitMargin');
        
        let basicScore = 0;
        let reasons = [];
        
        if (!isNaN(epsInput)) {
            if (epsInput >= 8) { 
                basicScore += 30; 
                reasons.push(`EPS ${epsInput.toFixed(2)} â‰¥ 8 (+30)`); 
            } else if (epsInput >= 5) { 
                basicScore += 25; 
                reasons.push(`EPS ${epsInput.toFixed(2)} â‰¥ 5 (+25)`); 
            } else if (epsInput >= 3) { 
                basicScore += 18; 
                reasons.push(`EPS ${epsInput.toFixed(2)} â‰¥ 3 (+18)`); 
            } else if (epsInput >= 0) { 
                basicScore += 5; 
                reasons.push(`EPS ${epsInput.toFixed(2)} â‰¥ 0 (+5)`); 
            } else { 
                basicScore -= 15; 
                reasons.push(`EPS ${epsInput.toFixed(2)} < 0 (-15)`); 
            }
        } else { 
            reasons.push('EPS ç„¡æ•¸æ“š'); 
        }

        if (!isNaN(roeInput)) {
            if (roeInput >= 15) { 
                basicScore += 30; 
                reasons.push(`ROE ${roeInput.toFixed(2)}% â‰¥ 15% (+30)`); 
            } else if (roeInput >= 10) { 
                basicScore += 20; 
                reasons.push(`ROE ${roeInput.toFixed(2)}% â‰¥ 10% (+20)`); 
            } else if (roeInput >= 5) { 
                basicScore += 10; 
                reasons.push(`ROE ${roeInput.toFixed(2)}% â‰¥ 5% (+10)`); 
            } else if (roeInput > 0) { 
                basicScore += 5; 
                reasons.push(`ROE ${roeInput.toFixed(2)}% > 0% (+5)`); 
            } else { 
                basicScore -= 10; 
                reasons.push(`ROE ${roeInput.toFixed(2)}% â‰¤ 0% (-10)`); 
            }
        } else { 
            reasons.push('ROE ç„¡æ•¸æ“š'); 
        }

        if (!isNaN(revenueGrowthInput)) {
            if (revenueGrowthInput >= 30) { 
                basicScore += 30; 
                reasons.push(`ç‡Ÿæ”¶å¢ç‡ ${revenueGrowthInput.toFixed(2)}% â‰¥ 30% (+30)`); 
            } else if (revenueGrowthInput >= 10) { 
                basicScore += 20; 
                reasons.push(`ç‡Ÿæ”¶å¢ç‡ ${revenueGrowthInput.toFixed(2)}% â‰¥ 10% (+20)`); 
            } else if (revenueGrowthInput > 0) { 
                basicScore += 10; 
                reasons.push(`ç‡Ÿæ”¶å¢ç‡ ${revenueGrowthInput.toFixed(2)}% > 0% (+10)`); 
            } else { 
                basicScore -= 10; 
                reasons.push(`ç‡Ÿæ”¶å¢ç‡ ${revenueGrowthInput.toFixed(2)}% â‰¤ 0% (-10)`); 
            }
        } else { 
            reasons.push('ç‡Ÿæ”¶å¢ç‡ ç„¡æ•¸æ“š'); 
        }

        if (!isNaN(profitMarginInput)) {
            if (profitMarginInput >= 50) { 
                basicScore += 10; 
                reasons.push(`æ¯›åˆ© ${profitMarginInput.toFixed(2)}% â‰¥ 50% (+10)`); 
            } else if (profitMarginInput >= 20) { 
                basicScore += 5; 
                reasons.push(`æ¯›åˆ© ${profitMarginInput.toFixed(2)}% â‰¥ 20% (+5)`); 
            } else { 
                reasons.push(`æ¯›åˆ© ${profitMarginInput.toFixed(2)}% < 20% (0)`); 
            }
        } else { 
            reasons.push('æ¯›åˆ© ç„¡æ•¸æ“š'); 
        }
        
        const weight = weights.basic || 35;
        const finalBasicScore = Math.max(-weight, Math.min(weight, Math.round(basicScore / 100 * weight)));
        
        const basicScoreEl = document.getElementById('score_basic');
        if (basicScoreEl) {
            basicScoreEl.textContent = `${finalBasicScore >= 0 ? '+' : ''}${finalBasicScore}`;
            basicScoreEl.className = `badge ${finalBasicScore >= 0 ? 'badge-pos' : 'badge-neg'} fs-5`;
        }
        
        const descEl = document.querySelector('#scoreTable tbody tr:nth-child(1) td:nth-child(4)');
        if (descEl) {
            descEl.innerHTML = `<small>${reasons.join('<br>')}</small>`;
        }
        
        log(`åŸºæœ¬é¢è©•åˆ†: ${finalBasicScore} (åŸå§‹: ${basicScore}, æ¬Šé‡: ${weight}%)`);
        
        updateTotalScore();
    };

    window.adjustWeights = function(changedField, newValue) {
        // é©—è­‰è¼¸å…¥
        const validation = validateWeightInput(newValue, 'æ¬Šé‡');
        if (!validation.valid) {
            showToast(validation.message, 'error');
            // æ¢å¾©åŸå§‹å€¼
            const input = document.querySelector(`.weight-input[data-field="${changedField}"]`);
            if (input) {
                input.value = weights[changedField];
            }
            return;
        }
        
        const validValue = validation.value;
        const oldValue = weights[changedField];
        const diff = validValue - oldValue;
        if (diff === 0) return;
        
        weights[changedField] = validValue;
        const otherFields = Object.keys(weights).filter(key => key !== changedField);
        const otherTotal = otherFields.reduce((sum, key) => sum + weights[key], 0);
        
        if (otherTotal === 0) {
            const avg = (100 - validValue) / otherFields.length;
            otherFields.forEach(key => weights[key] = avg);
        } else {
            const scale = (100 - validValue) / otherTotal;
            otherFields.forEach(key => weights[key] = Math.max(0, Math.round(weights[key] * scale * 10) / 10));
        }
        
        const total = Object.values(weights).reduce((sum, val) => sum + val, 0);
        if (Math.abs(total - 100) > 0.1) {
            const diff = 100 - total;
            const maxField = Object.keys(weights).reduce((a, b) => weights[a] > weights[b] ? a : b);
            weights[maxField] += diff;
        }
        
        updateWeightInputs();
        calculateBasicScoreFromManualInput(); 
        updateTotalScore();
        
        log(`æ¬Šé‡èª¿æ•´: ${changedField} = ${validValue}%, ç¸½è¨ˆ: ${Object.values(weights).reduce((a,b) => a + b, 0).toFixed(1)}%`);
    };

    function updateWeightInputs() {
        Object.keys(weights).forEach(key => {
            const input = document.querySelector(`.weight-input[data-field="${key}"]`);
            if (input) input.value = Math.round(weights[key]);
        });
    }

    function updateTotalScore() {
        const sum = Object.values(weights).reduce((a,b) => a + +b, 0);
        const hintEl = document.getElementById('weightHint');
        if (hintEl) {
            if (Math.abs(sum - 100) > 0.1) {
                hintEl.textContent = `âš ï¸ ç¸½æ¬Šé‡ ${Math.round(sum)}% (æ‡‰ç‚º100%)`;
                hintEl.style.color = '#ffc107';
            } else {
                hintEl.textContent = '';
            }
        }

        const getScore = (id) => {
            const el = document.getElementById(id);
            return el ? parseFloat(el.innerText.replace('+','')) : 0;
        }

        const s = {
            basic: getScore('score_basic'),
            technical: getScore('score_technical'),
            market: getScore('score_market'),
            news: getScore('score_news'),
            risk: getScore('score_risk')
        };

        const total = s.basic + s.technical + s.market + s.news + s.risk;
        const final = Math.max(-30, Math.min(30, Math.round(total * 0.3))); 
        
        const color = final >= 0 ? 'text-success' : 'text-danger';
        const finalEl = document.getElementById('finalScore');
        if (finalEl) {
            finalEl.innerHTML = `<h1 class="score-big ${color}">${final >= 0 ? '+' : ''}${final}%</h1>`;
        }
    }

    // ================= ä¸»åˆ†æè¡¨å–®æäº¤ - å·²ä¿®æ”¹é—œéµéƒ¨åˆ† =================
    
    document.getElementById('analyzeForm').onsubmit = async e => {
        e.preventDefault();
        
        // ç¢ºå®šä½¿ç”¨å“ªå€‹æ–¹å¼ç²å–è‚¡ç¥¨ä»£ç¢¼
        const stockSelect = document.getElementById('stockSelect');
        const listedStockSelect = document.getElementById('listedStockSelect');
        const searchStockInput = document.getElementById('searchStockInput');
        
        let symbol = '';
        let stockName = '';
        
        // 1. å„ªå…ˆæª¢æŸ¥ä¸Šå¸‚å…¬å¸é¸æ“‡æ¸…å–®
        if (listedStockSelect && listedStockSelect.value && listedStockSelect.value !== '') {
            symbol = listedStockSelect.value.trim();
            
            // å¾é¸é …ä¸­ç²å–è‚¡ç¥¨åç¨±
            const selectedOption = listedStockSelect.options[listedStockSelect.selectedIndex];
            if (selectedOption && selectedOption.textContent) {
                const text = selectedOption.textContent.trim();
                const match = text.match(/^\d+\s+(.+?)(?:\s+\([ä¸Šä¸­èˆˆ]å¸‚\))?$/);
                stockName = match ? match[1] : text;
            }
            
            log(`ä½¿ç”¨ä¸Šå¸‚å…¬å¸é¸æ“‡æ¸…å–®: ${symbol} ${stockName}`);
        } 
        // 2. å¦‚æœä¸Šå¸‚å…¬å¸æ¸…å–®æ²’æœ‰é¸æ“‡ï¼Œæª¢æŸ¥ä¸»è‚¡ç¥¨é¸æ“‡æ¸…å–®
        else if (stockSelect && stockSelect.value && stockSelect.value !== '') {
            symbol = stockSelect.value.trim();
            
            // å¾é¸é …ä¸­ç²å–è‚¡ç¥¨åç¨±
            const selectedOption = stockSelect.options[stockSelect.selectedIndex];
            if (selectedOption && selectedOption.textContent) {
                const text = selectedOption.textContent.trim();
                const match = text.match(/^\d+\s+(.+?)(?:\s+\([ä¸Šä¸­èˆˆ]å¸‚\))?$/);
                stockName = match ? match[1] : text;
            }
            
            log(`ä½¿ç”¨ä¸»è‚¡ç¥¨é¸æ“‡æ¸…å–®: ${symbol} ${stockName}`);
        }
        // 3. å¦‚æœéƒ½æ²’æœ‰é¸æ“‡ï¼Œæª¢æŸ¥æœç´¢è¼¸å…¥æ¡†
        else if (searchStockInput && searchStockInput.value.trim()) {
            symbol = searchStockInput.value.trim();
            
            log(`ä½¿ç”¨æœç´¢è¼¸å…¥æ¡†: ${symbol}`);
            
            // å˜—è©¦å¾æœç´¢è¼¸å…¥æ¡†ä¸­è§£æè‚¡ç¥¨ä»£ç¢¼
            // å¦‚æœæ˜¯ç´”æ•¸å­—ï¼Œå‡è¨­æ˜¯è‚¡ç¥¨ä»£ç¢¼
            if (/^\d{4}$/.test(symbol)) {
                // é€™æ˜¯è‚¡ç¥¨ä»£ç¢¼ï¼Œéœ€è¦æª¢æ¸¬å…¬å¸é¡å‹å’Œç²å–è‚¡ç¥¨åç¨±
                const detectionResult = await detectCompanyType(symbol);
                if (detectionResult && detectionResult.type !== 'not_found' && detectionResult.type !== 'unknown') {
                    stockName = detectionResult.stock_name || symbol;
                    log(`æœç´¢è¼¸å…¥æ¡†ä¸­æª¢æ¸¬åˆ°è‚¡ç¥¨: ${symbol} ${stockName}`);
                } else {
                    // å¦‚æœæª¢æ¸¬ä¸åˆ°ï¼Œä½¿ç”¨ä»£ç¢¼ä½œç‚ºåç¨±
                    stockName = symbol;
                }
            } else {
                // å¯èƒ½æ˜¯å…¬å¸åç¨±æˆ–æ··åˆè¼¸å…¥ï¼Œå…ˆä½¿ç”¨è¼¸å…¥ä½œç‚ºåç¨±
                stockName = symbol;
                // å˜—è©¦å¾è¼¸å…¥ä¸­æå–æ•¸å­—éƒ¨åˆ†ä½œç‚ºè‚¡ç¥¨ä»£ç¢¼
                const codeMatch = symbol.match(/\d+/);
                if (codeMatch) {
                    symbol = codeMatch[0];
                    log(`å¾æœç´¢è¼¸å…¥æ¡†æå–è‚¡ç¥¨ä»£ç¢¼: ${symbol}`);
                }
            }
        }
        else {
            showToast('è«‹é¸æ“‡æˆ–è¼¸å…¥è‚¡ç¥¨', 'error');
            showValidationError('searchStockInput', 'è«‹é¸æ“‡æˆ–è¼¸å…¥è‚¡ç¥¨');
            return;
        }
        
        if (!symbol) { 
            showToast('è«‹é¸æ“‡æˆ–è¼¸å…¥è‚¡ç¥¨', 'error');
            return; 
        }
        
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        // é©—è­‰æ—¥æœŸç¯„åœ
        const dateValidation = validateDateRange(startDate, endDate);
        if (!dateValidation.valid) {
            showToast(dateValidation.message, 'error');
            if (dateValidation.message.includes('é–‹å§‹æ—¥æœŸ')) {
                showValidationError('startDate', dateValidation.message);
            } else if (dateValidation.message.includes('çµæŸæ—¥æœŸ')) {
                showValidationError('endDate', dateValidation.message);
            }
            return;
        }
        
        // æª¢æŸ¥å…¬å¸é¡å‹
        let companyTypeToUse;
        if (currentCompanyType === 'auto') {
            if (!detectedCompanyType) {
                // å¦‚æœé‚„æ²’æœ‰æª¢æ¸¬éï¼Œç¾åœ¨æª¢æ¸¬
                log(`è‡ªå‹•æª¢æ¸¬å…¬å¸é¡å‹: ${symbol}`);
                const detectionResult = await detectCompanyType(symbol);
                if (!detectionResult || detectionResult.type === 'not_found' || detectionResult.type === 'unknown') {
                    showToast('ç„¡æ³•è­˜åˆ¥å…¬å¸é¡å‹ï¼Œè«‹æ‰‹å‹•é¸æ“‡ä¸Šå¸‚å…¬å¸ã€ä¸Šæ«ƒå…¬å¸æˆ–èˆˆæ«ƒå…¬å¸', 'error');
                    return;
                }
                companyTypeToUse = detectionResult.type;
                log(`è‡ªå‹•æª¢æ¸¬çµæœ: ${companyTypeToUse}`);
            } else {
                companyTypeToUse = detectedCompanyType;
            }
        } else {
            companyTypeToUse = currentCompanyType;
        }
        
        log(`=== åˆ†æé–‹å§‹ï¼š${symbol} ${stockName} (${companyTypeToUse === 'listed' ? 'ä¸Šå¸‚å…¬å¸' : companyTypeToUse === 'otc' ? 'ä¸Šæ«ƒå…¬å¸' : 'èˆˆæ«ƒå…¬å¸'}) ===`);
        
        const loadingEl = document.getElementById('loading');
        const resultEl = document.getElementById('result');
        const logContentEl = document.getElementById('logContent');
        
        if (loadingEl) loadingEl.style.display = 'block';
        if (resultEl) resultEl.style.display = 'none';
        if (logContentEl) logContentEl.textContent = '';

        try {
            let industry = 'æœªçŸ¥';
            
            // æ ¹æ“šå…¬å¸é¡å‹ç²å–è‚¡ç¥¨ä¿¡æ¯
            if (companyTypeToUse === 'listed') {
                const stock = stockData.listed.find(s => s.stock_id === symbol);
                if (stock) { 
                    if (!stockName) stockName = stock.stock_name;
                    industry = stock.industry_category; 
                }
            } else {
                // ä¸Šæ«ƒ/èˆˆæ«ƒå…¬å¸ï¼šä½¿ç”¨æª¢æ¸¬çµæœæˆ–é»˜èª
                if (!stockName || stockName === symbol) {
                    const detectionResult = await detectCompanyType(symbol);
                    if (detectionResult && detectionResult.stock_name) {
                        stockName = detectionResult.stock_name;
                    }
                }
                industry = companyTypeToUse === 'otc' ? 'ä¸Šæ«ƒå¸‚å ´' : 'èˆˆæ«ƒå¸‚å ´';
            }

            let priceDataFinal;
            let dataSource = '';
            
            if (companyTypeToUse === 'listed') {
                // ä¸Šå¸‚å…¬å¸ï¼šå…ˆå˜—è©¦TWSEï¼Œå¦‚æœå¤±æ•—å‰‡å˜—è©¦TPEx
                log('å˜—è©¦å¾TWSEç²å–ä¸Šå¸‚å…¬å¸è‚¡åƒ¹...');
                priceDataFinal = await fetchYahooWithProxy(`${symbol}.TW`, 'TWSEä¸Šå¸‚å…¬å¸è‚¡åƒ¹');
                
                if (!priceDataFinal) {
                    log('TWSEå¤±æ•—ï¼Œå˜—è©¦å¾TPExç²å–...');
                    // å˜—è©¦TPExä½œç‚ºå‚™æ´
                    try {
                        const tpexResponse = await fetch(`/.netlify/functions/fetch-tpex?stock_id=${symbol}&data_type=price&company_type=listed`);
                        if (tpexResponse.ok) {
                            const tpexData = await tpexResponse.json();
                            if (tpexData.success) {
                                priceDataFinal = { chart: { result: [tpexData.price_data] } };
                                dataSource = 'TPEx (å‚™æ´)';
                                log('âœ… TPExå‚™æ´æˆåŠŸç²å–è‚¡åƒ¹æ•¸æ“š');
                            }
                        }
                    } catch (err) {
                        log(`TPExå‚™æ´ç²å–å¤±æ•—: ${err.message}`);
                    }
                    
                    // å¦‚æœTPExä¹Ÿå¤±æ•—ï¼Œå˜—è©¦ç›´æ¥å¾è­‰äº¤æ‰€API
                    if (!priceDataFinal) {
                        log('TPExå‚™æ´å¤±æ•—ï¼Œå˜—è©¦ç›´æ¥å¾è­‰äº¤æ‰€API...');
                        const twsePrice = await fetchTWSEPrice(symbol);
                        if (twsePrice) {
                            priceDataFinal = { chart: { result: [{ 
                                timestamp: twsePrice.map(d => { 
                                    const p = d.Date.split('/'); 
                                    return new Date(`${+p[0]+1911}-${p[1]}-${p[2]}`).getTime()/1000; 
                                }), 
                                indicators: { quote: [{ 
                                    close: twsePrice.map(d => parseFloat(d.Close.replace(/,/g, ''))) 
                                }] } 
                            }] } };
                            dataSource = 'TWSEç›´æ¥API';
                            log('âœ… TWSEç›´æ¥APIæˆåŠŸç²å–è‚¡åƒ¹æ•¸æ“š');
                        }
                    }
                } else {
                    dataSource = 'TWSE';
                }
            } else {
                // ä¸Šæ«ƒ/èˆˆæ«ƒå…¬å¸ï¼šä½¿ç”¨.TWOå¾Œç¶´æˆ–TPEx API
                log(`å˜—è©¦å¾Yahoo Financeç²å–${companyTypeToUse === 'otc' ? 'ä¸Šæ«ƒ' : 'èˆˆæ«ƒ'}å…¬å¸è‚¡åƒ¹...`);
                priceDataFinal = await fetchYahooWithProxy(`${symbol}.TWO`, `${companyTypeToUse === 'otc' ? 'ä¸Šæ«ƒ' : 'èˆˆæ«ƒ'}å…¬å¸è‚¡åƒ¹`);
                dataSource = 'Yahoo Finance';
                
                if (!priceDataFinal) {
                    log('Yahoo Financeå¤±æ•—ï¼Œå˜—è©¦TPEx API...');
                    // å˜—è©¦TPExè‚¡åƒ¹API
                    try {
                        const tpexResponse = await fetch(`/.netlify/functions/fetch-tpex?stock_id=${symbol}&data_type=price&company_type=${companyTypeToUse}`);
                        if (tpexResponse.ok) {
                            const tpexData = await tpexResponse.json();
                            if (tpexData.success) {
                                priceDataFinal = { chart: { result: [tpexData.price_data] } };
                                dataSource = 'TPEx';
                                log(`âœ… TPExæˆåŠŸç²å–${companyTypeToUse === 'otc' ? 'ä¸Šæ«ƒ' : 'èˆˆæ«ƒ'}å…¬å¸è‚¡åƒ¹æ•¸æ“š`);
                            }
                        }
                    } catch (err) {
                        log(`TPExè‚¡åƒ¹ç²å–å¤±æ•—: ${err.message}`);
                    }
                }
            }
            
            if (!priceDataFinal) {
                throw new Error('ç„¡æ³•å–å¾—è‚¡åƒ¹è³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–é¸æ“‡å…¶ä»–è‚¡ç¥¨');
            }

            // ä½¿ç”¨æ–°çš„è²¡å‹™æ•¸æ“šç²å–å‡½æ•¸
            log(`ç²å–è²¡å‹™æ•¸æ“š: ${symbol}`);
            const financialResult = await fetchFinancialData(symbol);
            const finSource = financialResult?.source || 'ç„¡';
            const finCompanyType = financialResult?.companyType || companyTypeToUse;
            
            // æ›´æ–°æ•¸æ“šä¾†æºé¡¯ç¤ºï¼ˆåˆä½µè‚¡åƒ¹å’Œè²¡å‹™æ•¸æ“šä¾†æºï¼‰
            const combinedSource = dataSource ? `${dataSource} + ${finSource}` : finSource;
            updateDataSourceInfo(finCompanyType, combinedSource);
            
            let newsRaw = null;
            if (TOKEN && companyTypeToUse === 'listed') {
                // åªæœ‰ä¸Šå¸‚å…¬å¸æœ‰æ–°èæ•¸æ“š
                newsRaw = await fetchFinmind('TaiwanStockNews', symbol, startDate);
            }

            let marketData = await fetchYahooWithProxy('%5ETWII', 'å¤§ç›¤');

            const allTimestamps = priceDataFinal.chart.result[0].timestamp;
            const allCloses = priceDataFinal.chart.result[0].indicators.quote[0].close;
            const startTs = new Date(startDate).getTime() / 1000;
            const endTs = new Date(endDate).getTime() / 1000;
            
            const filteredData = allTimestamps.map((ts, i) => ({ ts, close: allCloses[i] })).filter(d => d.ts >= startTs && d.ts <= endTs && d.close);
            const closes = filteredData.map(d => d.close);
            const timestamps = filteredData.map(d => d.ts);
            
            if (closes.length === 0) {
                throw new Error('æŒ‡å®šæ—¥æœŸç¯„åœå…§ç„¡è‚¡åƒ¹è³‡æ–™ï¼Œè«‹èª¿æ•´æ—¥æœŸç¯„åœ');
            }

            const price = closes.at(-1).toFixed(2);
            const risePercent = closes.length >= 2 ? ((closes.at(-1) - closes[0]) / closes[0] * 100).toFixed(2) : 0;
            
            const techW = weights.technical || 25;
            let techScore = 0;
            let techReason = 'å€é–“éœ‡ç›ª';
            if (risePercent >= 30) { 
                techScore = techW; 
                techReason = `å€é–“æ¼²å¹… ${risePercent}% (â‰¥30% ç²æ»¿åˆ†)`; 
            } else if (risePercent >= 15) { 
                techScore = Math.round(techW * 0.8); 
                techReason = `å€é–“æ¼²å¹… ${risePercent}% (â‰¥15% ç²80%åˆ†)`; 
            } else if (risePercent >= 5) { 
                techScore = Math.round(techW * 0.4); 
                techReason = `å€é–“æ¼²å¹… ${risePercent}% (â‰¥5% ç²40%åˆ†)`; 
            } else if (risePercent < -10) { 
                techScore = -Math.round(techW * 0.8); 
                techReason = `å€é–“è·Œå¹… ${risePercent}% (<-10% æ‰£åˆ†)`; 
            } else {
                techScore = 0; 
                techReason = `å€é–“æ¼²è·Œ ${risePercent}% (ç›¤æ•´ä¸è¨ˆåˆ†)`; 
            }

            const marketW = weights.market || 20;
            let marketScore = 0; 
            let marketReason = 'ç„¡è³‡æ–™';
            if (marketData) {
                const mCloses = marketData.chart.result[0].indicators.quote[0].close.filter(Boolean);
                const mStart = mCloses[mCloses.length - closes.length] || mCloses[0];
                const mEnd = mCloses[mCloses.length - 1];
                const mRise = ((mEnd - mStart) / mStart * 100).toFixed(2);
                const beat = (parseFloat(risePercent) - parseFloat(mRise)).toFixed(1);
                
                if (beat >= 20) { 
                    marketScore = marketW; 
                    marketReason = `å¼·æ–¼å¤§ç›¤ ${beat}% (â‰¥20% ç²æ»¿åˆ†)`; 
                } else if (beat >= 0) { 
                    marketScore = Math.round(marketW * 0.4); 
                    marketReason = `å¼·æ–¼å¤§ç›¤ ${beat}% (â‰¥0% ç²40%åˆ†)`; 
                } else { 
                    marketScore = -Math.round(marketW * 0.6); 
                    marketReason = `å¼±æ–¼å¤§ç›¤ ${beat}% (è½å¾Œæ‰£åˆ†)`; 
                }
            }

            const newsW = weights.news || 10;
            let newsScore = 0;
            let newsReason = companyTypeToUse === 'listed' ? 'ç„¡æ–°è' : 'ä¸Šæ«ƒ/èˆˆæ«ƒå…¬å¸æš«ç„¡æ–°èåˆ†æ';
            if (newsRaw?.data?.length > 0 && companyTypeToUse === 'listed') {
                let sentiment = 0;
                newsRaw.data.slice(0,30).forEach(n => {
                    if (n.title.match(/ç²åˆ©|æˆé•·|æ–°é«˜|è¨‚å–®|å¤§æ¼²/)) sentiment++;
                    if (n.title.match(/è™§æ|è¡°é€€|è£å“¡|åˆ©ç©º|å¤§è·Œ/)) sentiment--;
                });
                if (sentiment >= 5) { 
                    newsScore = newsW; 
                    newsReason = `æƒ…ç·’æŒ‡æ•¸ ${sentiment} (â‰¥5 ç²æ»¿åˆ†)`; 
                } else if (sentiment > 0) { 
                    newsScore = Math.round(newsW * 0.5); 
                    newsReason = `æƒ…ç·’æŒ‡æ•¸ ${sentiment} (>0 ç²50%åˆ†)`; 
                } else { 
                    newsScore = -Math.round(newsW * 0.5); 
                    newsReason = `æƒ…ç·’æŒ‡æ•¸ ${sentiment} (â‰¤0 åç©ºæ‰£åˆ†)`; 
                }
            }
            
            const riskW = weights.risk || 10;
            let riskScore = 0;
            let riskReason = 'ç„¡é‡å¤§é¢¨éšª'; 

            const currentEPS = parseFloat(financialCache.eps.year); 
            const currentROE = parseFloat(financialCache.roe.year);
            
            if (!isNaN(currentEPS) && !isNaN(currentROE)) {
                if (currentEPS < 0 && currentROE < 0) {
                    riskScore = -riskW;
                    riskReason = `EPS(${currentEPS})èˆ‡ROE(${currentROE})é›™è™§æ (é‡æ‰£)`;
                } else if (currentEPS < 0) {
                    riskScore = -Math.round(riskW * 0.5);
                    riskReason = `EPS(${currentEPS}) ç‚ºè² å€¼ (æ‰£åˆ†)`;
                } else {
                    riskScore = 0;
                    riskReason = `EPS(${currentEPS})èˆ‡ROE(${currentROE})çš†ç‚ºæ­£ (ç„¡é¢¨éšª)`;
                }
            } else {
                 riskReason = "ç„¡å®Œæ•´è²¡å ±æ•¸æ“š (ä¸è¨ˆåˆ†)";
            }
            
            // ç”ŸæˆçµæœHTML
            if (resultEl) {
                resultEl.innerHTML = `
                    <div class="text-center mb-5">
                        <h2>${symbol} ${stockName} <small class="text-info">(${industry})</small></h2>
                        <div class="mb-2">
                            <span class="badge ${companyTypeToUse === 'listed' ? 'bg-success' : companyTypeToUse === 'otc' ? 'bg-primary' : 'bg-warning'}">
                                ${companyTypeToUse === 'listed' ? 'ğŸ¢ ä¸Šå¸‚å…¬å¸' : companyTypeToUse === 'otc' ? 'ğŸ“Š ä¸Šæ«ƒå…¬å¸' : 'ğŸ“ˆ èˆˆæ«ƒå…¬å¸'}
                            </span>
                        </div>
                        <div id="finalScore"><h1 class="score-big">--</h1></div>
                        <p class="lead">æ•´é«”å¸‚å ´è¶¨å‹¢è©•åˆ† <span id="weightHint" style="color:yellow"></span></p>
                        <p class="fs-5">ç¾åƒ¹ ${price} ï½œ æœŸé–“æ¼²è·Œ ${risePercent}%</p>
                        <p class="data-source">è³‡æ–™ä¾†æº: <span id="resultDataSource">${combinedSource}</span></p>
                    </div>

                    <div class="row g-4 data-section">
                        <div class="col-lg-5">
                            <div class="card text-dark">
                                <div class="card-header bg-primary text-white"><strong>æœ€æ–°è²¡å ±æ•¸æ“š</strong></div>
                                <div class="financial-period"><small class="text-muted">è«‹ä½¿ç”¨ä¸‹æ–¹é¸å–®åˆ‡æ›åˆ†æç¶­åº¦</small></div>
                                <table class="table table-striped mb-0">
                                    <thead><tr><th>é …ç›®</th><th>æœŸé–“</th><th>æ•¸å€¼</th><th class="manual-label">è¼¸å…¥</th></tr></thead>
                                    <tbody>
                                        <tr>
                                            <td>EPS</td>
                                            <td><select class="form-select period-select" data-type="eps"><option value="å­£">å­£</option><option value="å¹´">å¹´</option></select></td>
                                            <td class="fw-bold fs-5" id="displayEps">N/A</td>
                                            <td class="manual-input-cell"><input type="number" id="manualEps" class="form-control manual-input" step="0.01"></td>
                                        </tr>
                                        <tr>
                                            <td>ROE</td>
                                            <td><select class="form-select period-select" data-type="roe"><option value="å­£">å­£</option><option value="å¹´">å¹´</option></select></td>
                                            <td class="fs-5" id="displayRoe">N/A</td>
                                            <td class="manual-input-cell"><input type="number" id="manualRoe" class="form-control manual-input" step="0.1"></td>
                                        </tr>
                                        <tr>
                                            <td>ç‡Ÿæ”¶å¢ç‡</td>
                                            <td><select class="form-select period-select" data-type="revenue"><option value="æœˆ">æœˆ</option><option value="å­£">å­£</option><option value="å¹´">å¹´(ç´¯è¨ˆ)</option></select></td>
                                            <td class="fs-5" id="displayRevenue">N/A</td>
                                            <td class="manual-input-cell"><input type="number" id="manualRevenueGrowth" class="form-control manual-input" step="0.1"></td>
                                        </tr>
                                        <tr>
                                            <td>æ¯›åˆ©ç‡</td>
                                            <td><select class="form-select period-select" data-type="margin"><option value="å­£">å­£</option></select></td>
                                            <td class="fs-5" id="displayMargin">N/A</td>
                                            <td class="manual-input-cell"><input type="number" id="manualProfitMargin" class="form-control manual-input" step="0.1"></td>
                                        </tr>
                                    </tbody>
                                </table>
                                
                                <!-- æ–°å¢æœ€æ–°è²¡å ±æ•¸æ“šèªªæ˜ -->
                                <div class="explanation mt-3">
                                    <h6>ğŸ“ˆ è²¡å ±æ•¸æ“šèªªæ˜</h6>
                                    <ul class="mb-0 small ps-3">
                                        <li><strong>EPS (æ¯è‚¡ç›ˆé¤˜):</strong> å…¬å¸æ¯è‚¡è‚¡ç¥¨è³ºå¤šå°‘éŒ¢ï¼Œå­£æ•¸æ“šä½¿ç”¨å‰ä¸€å­£ç¢ºä¿æº–ç¢ºæ€§</li>
                                        <li><strong>ROE (è‚¡æ±æ¬Šç›Šå ±é…¬ç‡):</strong> å…¬å¸é‹ç”¨è‚¡æ±è³‡é‡‘è³ºéŒ¢çš„æ•ˆç‡</li>
                                        <li><strong>ç‡Ÿæ”¶å¢ç‡:</strong> æœˆå¢ç‡ç‚ºæœ¬æœˆèˆ‡ä¸Šæœˆæ¯”è¼ƒï¼Œå­£/å¹´å¢ç‡ç‚ºèˆ‡å»å¹´åŒæœŸæ¯”è¼ƒ</li>
                                        <li><strong>æ¯›åˆ©ç‡:</strong> ç”¢å“æˆ–æœå‹™çš„ç²åˆ©èƒ½åŠ›ï¼Œåƒ…æä¾›å­£åº¦æ•¸æ“š</li>
                                        <li>å¯æ‰‹å‹•è¼¸å…¥æ•¸å€¼é€²è¡Œå³æ™‚è©•åˆ†èª¿æ•´</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-7">
                            <div class="card text-dark">
                                <div class="card-header bg-danger text-white table-header-red"><strong>å°ˆæ¥­è©•åˆ†</strong></div>
                                <table class="table table-striped mb-0" id="scoreTable">
                                    <thead><tr><th>é …ç›®</th><th>æ¬Šé‡%</th><th>å¾—åˆ†</th><th>èªªæ˜</th></tr></thead>
                                    <tbody>
                                        <tr><td>åŸºæœ¬é¢</td><td><input type="number" data-field="basic" class="form-control weight-input" value="${weights.basic}" onchange="adjustWeights('basic',+this.value)"></td><td><span class="badge badge-pos fs-5" id="score_basic">0</span></td><td>è²¡å ±</td></tr>
                                        <tr><td>æŠ€è¡“é¢</td><td><input type="number" data-field="technical" class="form-control weight-input" value="${weights.technical}" onchange="adjustWeights('technical',+this.value)"></td><td><span class="badge badge-pos fs-5" id="score_technical">${techScore}</span></td><td>${techReason}</td></tr>
                                        <tr><td>å¸‚å ´é¢</td><td><input type="number" data-field="market" class="form-control weight-input" value="${weights.market}" onchange="adjustWeights('market',+this.value)"></td><td><span class="badge badge-pos fs-5" id="score_market">${marketScore}</span></td><td>${marketReason}</td></tr>
                                        <tr><td>æ¶ˆæ¯é¢</td><td><input type="number" data-field="news" class="form-control weight-input" value="${weights.news}" onchange="adjustWeights('news',+this.value)"></td><td><span class="badge badge-pos fs-5" id="score_news">${newsScore}</span></td><td>${newsReason}</td></tr>
                                        <tr><td>é¢¨éšªé¢</td><td><input type="number" data-field="risk" class="form-control weight-input" value="${weights.risk}" onchange="adjustWeights('risk',+this.value)"></td><td><span class="badge badge-pos fs-5" id="score_risk">${riskScore}</span></td><td>${riskReason}</td></tr>
                                    </tbody>
                                </table>
                                
                                <!-- ç§»å‹•å°ˆæ¥­è©•åˆ†é …ç›®èªªæ˜åˆ°é€™è£¡ -->
                                <div class="explanation mt-3">
                                    <h6>ğŸ“Š å°ˆæ¥­è©•åˆ†é …ç›®èªªæ˜</h6>
                                    <ul class="mb-0 small ps-3">
                                        <li><strong>1. åŸºæœ¬é¢ (35%):</strong> ä¾æ“šè²¡å ±æ•¸å€¼è©•åˆ† (EPS>8, ROE>15%, ç‡Ÿæ”¶æˆé•·>30% ç‚ºæ»¿åˆ†)ã€‚</li>
                                        <li><strong>2. æŠ€è¡“é¢ (25%):</strong> ä¾æ“šå€é–“è‚¡åƒ¹æ¼²è·Œå¹…åˆ¤æ–·å‹•èƒ½ (æ¼²å¹…>30%æ»¿åˆ†)ã€‚</li>
                                        <li><strong>3. å¸‚å ´é¢ (20%):</strong> èˆ‡å¤§ç›¤æŒ‡æ•¸åŒæœŸæ¼²è·Œå¹…æ¯”è¼ƒï¼Œå‹éå¤§ç›¤å³å¾—åˆ†ã€‚</li>
                                        <li><strong>4. æ¶ˆæ¯é¢ (10%):</strong> åˆ†æè¿‘æœŸæ–°èé—œéµå­— (ç‡Ÿæ”¶æ–°é«˜/æˆé•· vs è¡°é€€/è£å“¡)ã€‚</li>
                                        <li><strong>5. é¢¨éšªé¢ (10%):</strong> é‡å°è²¡å‹™èµ¤å­— (è² EPS/ROE) é€²è¡Œé¢¨éšªæ‰£åˆ†ã€‚</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container card mt-4">
                        <div class="card-body"><canvas id="priceChart"></canvas></div>
                    </div>
                `;
            }

            setupPeriodChangeListeners();
            setupManualInputListeners();
            updateFinancialUI();
            
            // æ›´æ–°çµæœä¸­çš„æ•¸æ“šä¾†æº
            const resultDataSource = document.getElementById('resultDataSource');
            if (resultDataSource) {
                resultDataSource.textContent = combinedSource;
            }

            // ç²å–å¤§ç›¤æ•¸æ“š
            let marketCloses = [];
            if (marketData) {
                marketCloses = marketData.chart.result[0].indicators.quote[0].close.slice(-closes.length);
            }
            
            // è¨ˆç®—æ¨™æº–åŒ–æ•¸æ“šï¼Œè®“å…©æ¢æ›²ç·šåœ¨åŒä¸€ç¯„åœé¡¯ç¤º
            const normalizeData = (data) => {
                if (!data || data.length === 0) return [];
                
                const min = Math.min(...data);
                const max = Math.max(...data);
                const range = max - min;
                
                if (range === 0) {
                    return data.map(() => 50);
                }
                
                return data.map(value => ((value - min) / range) * 100);
            };
            
            // æ¨™æº–åŒ–å€‹è‚¡å’Œå¤§ç›¤æ•¸æ“š
            const normalizedCloses = normalizeData(closes);
            const normalizedMarketCloses = marketCloses.length > 0 ? normalizeData(marketCloses) : [];
            
            // å‰µå»ºåœ–è¡¨
            const chartCanvas = document.getElementById('priceChart');
            if (chartCanvas) {
                const ctx = chartCanvas.getContext('2d');
                
                // æª¢æŸ¥æ˜¯å¦æœ‰ä¹‹å‰çš„åœ–è¡¨å¯¦ä¾‹ï¼Œå¦‚æœæœ‰å‰‡éŠ·æ¯€
                if (window.priceChartInstance && typeof window.priceChartInstance.destroy === 'function') {
                    window.priceChartInstance.destroy();
                }
                
                window.priceChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: timestamps.map(t => {
                            const date = new Date(t*1000);
                            return date.toLocaleDateString('zh-TW',{month:'numeric',day:'numeric'});
                        }),
                        datasets: [
                            { 
                                label: stockName, 
                                data: normalizedCloses, 
                                borderColor: '#00ff88',
                                backgroundColor: 'rgba(0, 255, 136, 0.1)',
                                tension: 0.3,
                                fill: false,
                                borderWidth: 2,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: 'black',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    padding: 20
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        const datasetLabel = context.dataset.label || '';
                                        const value = context.parsed.y;
                                        const index = context.dataIndex;
                                        
                                        if (datasetLabel === stockName) {
                                            const actualValue = closes[index];
                                            return `${datasetLabel}: ${actualValue ? actualValue.toFixed(2) : 'N/A'}`;
                                        }
                                        
                                        return `${datasetLabel}: ${value.toFixed(2)}%`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'æ—¥æœŸ',
                                    color: 'black',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                ticks: {
                                    color: 'black',
                                    maxTicksLimit: 10,
                                    font: {
                                        size: 12
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'æ¨™æº–åŒ–åƒ¹æ ¼ (%)',
                                    color: 'black',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                ticks: {
                                    color: 'black',
                                    callback: function(value) {
                                        return value.toFixed(0) + '%';
                                    },
                                    font: {
                                        size: 12
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                },
                                min: 0,
                                max: 100
                            }
                        },
                        elements: {
                            line: {
                                tension: 0.3
                            }
                        },
                        animation: {
                            duration: 1000
                        }
                    }
                });
                
                // å¦‚æœæœ‰å¤§ç›¤æ•¸æ“šï¼Œæ·»åŠ ç¬¬äºŒæ¢ç·š
                if (normalizedMarketCloses.length > 0) {
                    window.priceChartInstance.data.datasets.push({
                        label: 'å¤§ç›¤', 
                        data: normalizedMarketCloses, 
                        borderColor: '#ff4444',
                        backgroundColor: 'rgba(255, 68, 68, 0.1)',
                        tension: 0.3,
                        fill: false,
                        borderWidth: 2,
                        pointRadius: 0
                    });
                    window.priceChartInstance.update();
                }
            }

            if (resultEl) {
                resultEl.style.display = 'block';
            }

            log(`åˆ†æå®Œæˆ: ${symbol} ${stockName}`);
            showToast(`åˆ†æå®Œæˆ: ${symbol} ${stockName}`, 'success');

        } catch (err) {
            log(`éŒ¯èª¤: ${err.message}`);
            
            if (resultEl) {
                resultEl.innerHTML = `
                    <div class="alert alert-danger text-center py-5">
                        <h3>${err.message}</h3>
                        <p class="mt-3">
                            <button class="btn btn-warning retry-btn" onclick="location.reload()">é‡æ–°è¼‰å…¥é é¢</button>
                            <button class="btn btn-info retry-btn" onclick="document.getElementById('analyzeForm').onsubmit()">é‡æ–°å˜—è©¦åˆ†æ</button>
                        </p>
                    </div>
                `;
                resultEl.style.display = 'block';
            }
            
            showToast(`åˆ†æå¤±æ•—: ${err.message}`, 'error');
        }
        
        if (loadingEl) {
            loadingEl.style.display = 'none';
        }
    };

    // ================= åˆå§‹åŒ– =================
    function initialize() {
        try {
            // è¨­ç½®é»˜èªæ¬Šé‡
            window.weights = { basic:35, technical:25, market:20, news:10, risk:10 };
            
            // è¨­ç½®æ—¥æœŸç¯„åœ
            const today = new Date().toISOString().split('T')[0];
            const endDateEl = document.getElementById('endDate');
            if (endDateEl) {
                endDateEl.value = today;
            }
            
            // è¨­ç½®æ—¥æœŸç¯„åœè®ŠåŒ–è™•ç†
            const dateRangeEl = document.getElementById('dateRange');
            if (dateRangeEl) {
                dateRangeEl.addEventListener('change', function() {
                    const days = parseInt(this.value);
                    const end = new Date();
                    const start = new Date(end.getTime() - days * 24 * 60 * 60 * 1000);
                    
                    const startDateEl = document.getElementById('startDate');
                    if (startDateEl) {
                        startDateEl.value = start.toISOString().split('T')[0];
                    }
                    
                    if (endDateEl) {
                        endDateEl.value = today;
                    }
                });
                
                // è§¸ç™¼åˆå§‹è¨ˆç®—
                dateRangeEl.dispatchEvent(new Event('change'));
            }
            
            // åˆå§‹åŒ– Token é¡¯ç¤º
            const tokenInput = document.getElementById('tokenInput');
            const tokenStatus = document.getElementById('tokenStatus');
            if (tokenInput && tokenStatus) {
                tokenInput.value = TOKEN;
                if (TOKEN) {
                    tokenStatus.innerHTML = '<span style="color:#28a745">Token å·²å¾è¨˜éŒ„ä¸­è¼‰å…¥ (ä¸‹æ¬¡å…è¼¸å…¥)</span>';
                } else {
                    tokenStatus.innerHTML = '<span style="color:#ffc107">æœªè¨­å®š Tokenï¼Œå°‡ä½¿ç”¨å…¬é–‹è³‡æ–™</span>';
                }
            }
            
            // åˆå§‹åŒ–å…¬å¸é¡å‹é¡¯ç¤º
            updateCompanyTypeDisplay('unknown');
            updateDataSourceInfo(null);
            
            // åŠ è¼‰ AI é…ç½®
            loadAiConfig();
            
            // åŠ è¼‰æœå°‹æ­·å²
            loadSearchHistory();
            
            // åŠ è¼‰è‚¡ç¥¨æ•¸æ“š - åœ¨åˆå§‹åŒ–æ™‚å°±é–‹å§‹åŠ è¼‰
            loadStockData().then(() => {
                // è‚¡ç¥¨æ•¸æ“šåŠ è¼‰å®Œæˆå¾Œï¼Œæ›´æ–°è‚¡ç¥¨é¸æ“‡
                updateStockSelect();
                updateListedStockSelect();
                log('è‚¡ç¥¨æ•¸æ“šåŠ è¼‰å®Œæˆ');
            });
            
            log('ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
            
        } catch (error) {
            console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
            log(`åˆå§‹åŒ–éŒ¯èª¤: ${error.message}`);
            showToast('ç³»çµ±åˆå§‹åŒ–æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
        }
    }

    // æ—¥èªŒå‡½æ•¸
    window.log = function(msg) {
        const logEl = document.getElementById('logContent');
        if (logEl) {
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${msg}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        console.log(msg);
    }

    // é–‹å§‹åˆå§‹åŒ–
    initialize();
});
</script>
</body>
</html>